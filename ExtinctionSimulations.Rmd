---
title: "ExtinctionSimulations"
author: "Camille"
date: "4/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Data and Packages}
#check and set working directory

#load packages
library(bipartite)
library(phytools)
library(tidyverse)
library(geiger)
library(mosaicCore)
library(data.table)
library(network)
library(treeplyr)
library(ggpubr)


#load data

bipart<- read.csv("bipart.csv", header=T) #load in full network 
bipart2 <- bipart[,-1]
rownames(bipart2) <- bipart[,1]
bipart <- bipart2
vertextraits <- read.csv("verttraits1_10_22.csv", header=T) # traits for combined network species 
tree_l <- read.tree("lemurs.tre") #load in lemur phylogeny
bipart_frugivore <- read.csv("bipart_frugivore.csv")  #load in mutualistic network
bipart_frugivore2 <- bipart_frugivore[,-1]
rownames(bipart_frugivore2 ) <- bipart_frugivore[,1]
bipart_frugivore <- bipart_frugivore2 
bipart_antagonistic <- read.csv("bipart_antagonistic.csv") #load in antagonistic network
bipart_antagonistic[bipart_antagonistic=="-99"]<-0
bipart_antagonistic2 <- bipart_antagonistic[,-1]
rownames(bipart_antagonistic2 ) <- bipart_antagonistic[,1]
```

In this document, hybrid == combined 
Note: modularity analyses take a very long time to run

```{r Subset vertex traits for mutualistic and antagonistic networks}
animals_frugivore <- bipart_frugivore$X
plants_frugivore <- colnames(bipart_frugivore)
plants_frugivore <- plants_frugivore[-1]
species_frugivore <- c(animals_frugivore, plants_frugivore)
species_frugivore <- as.data.frame(species_frugivore)
colnames(species_frugivore) <- "species"
vertextraits_frugivore <- left_join(species_frugivore, vertextraits, by="species")

animals_antagonistic <- bipart_antagonistic$X
plants_antagonistic <- colnames(bipart_antagonistic)
plants_antagonistic <- plants_antagonistic[-1]
species_antagonistic <- c(animals_antagonistic, plants_antagonistic)
species_antagonistic <- as.data.frame(species_antagonistic)
colnames(species_antagonistic) <- "species"
vertextraits_antagonistic <- left_join(species_antagonistic, vertextraits, by="species")
```

#Hybrid Lemur Extinctions 

```{r Original Hybrid Network - Lemur}
#secondary extinction
# using random removal of lemurs, what is the average number of secondary extinctions 

# Scienario 1: Random 
(ex <- second.extinct(bipart, participant="lower", method="random", nrep=55, 
                      details=F))
ex
summary(ex)
plot(ex)
rob1<-robustness(ex)

exdf<-as.data.frame(ex[1:55,])
plot(exdf$ext.higher~exdf$no)


# Scenario 2: removal of lemurs from highest to lowest degree
(ex2 <- second.extinct(bipart, participant="lower", method="degree", nrep=55, 
                       details=F))
ex2
summary(ex2)
plot(ex2)
str(ex2)

ex2df<-as.data.frame(ex2[1:55,])
plot(ex2df$ext.higher~ex2df$no)

rob2<-robustness(ex2)


#Scenario 3: remove lemurs from lowest to highest degree

degreedf<-as.data.frame(net%v%"degree")
degreedf$node<-rownames(degreedf)
degreedf$name<-net%v%"vertex.names"
degreedfhost<-degreedf[1:55,]
degreedftree<-degreedf[-c(1:55),]
degreedfhost<-sort(degreedfhost)
as.numeric(degreedfhost$node)

(ex3 <- second.extinct(bipart, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost$node), 
                       details=F))
ex3
summary(ex3)
plot(ex3)
str(ex3)

ex3df<-as.data.frame(ex3[1:55,])
plot(ex3df$ext.higher~ex3df$no)

rob3<-robustness(ex3)

#Scenario 4: Remove lemurs according to extinction likelihood 

###using removal of hosts from most to least endangered

colnames(vertextraits)

vertextraits$IUCN_lemur <- as.character(vertextraits$IUCN)
vertextraits$IUCN_lemur[vertextraits$IUCN_lemur=="LC"] <- 1
vertextraits$IUCN_lemur[vertextraits$IUCN_lemur=="VU"] <- 3
vertextraits$IUCN_lemur[vertextraits$IUCN_lemur=="EN"] <- 4
vertextraits$IUCN_lemur[vertextraits$IUCN_lemur=="CR"] <- 5

endangdf<-data.frame(area=net%v%"area",
                     name=net%v%"vertex.names",
                     Threat=net%v%"Threat")
endangdf <-endangdf[1:55,]

endangdf$Threat[endangdf$Threat=="LC"] <- 1
endangdf$Threat[endangdf$Threat=="VU"] <- 3
endangdf$Threat[endangdf$Threat=="EN"] <- 4
endangdf$Threat[endangdf$Threat=="CR"] <- 5

endangdf$node<-rownames(endangdf)
endangdflemur<-endangdf[1:55,]
endangdflemur$status <- as.numeric(endangdflemur$Threat)

##order from first to last the species that are 1) most endangered and 2) smallest range
endangdflemur<-endangdflemur[order(-endangdflemur$status,endangdflemur$area),]
head(endangdflemur)

bipart <- bipart[1:55,]

(ex4 <- second.extinct(bipart, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur$node), 
                       details=F))
ex4
summary(ex4)
plot(ex4)
str(ex4)

rob4<-robustness(ex4)

ex4df<-as.data.frame(ex4[1:55,])
plot(ex4df$ext.higher~ex4df$no)

#combine the different extinction scenarios
exdfs<-cbind(exdf,ex2df,ex3df,ex4df)
colnames(exdfs)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
summary(exdfs)
##convert to %
exdfs$perc.no<-exdfs$no/55*100

exdfs$perc.ext.rand<-100-(exdfs$ext.rand/590*100)

exdfs$perc.ext.deghigh<-100-(exdfs$ext.deghigh/590*100)

exdfs$perc.ext.deglow<-100-((exdfs$ext.deglow/590)*100)

exdfs$perc.ext.end<-100-((exdfs$ext.end/590)*100)

exdfs$ext.rand.cum <- cumsum(exdfs$ext.rand)
exdfs$ext.deghigh.cum <- cumsum(exdfs$ext.deghigh)
exdfs$ext.deglow.cum <- cumsum(exdfs$ext.deglow)
exdfs$ext.end.cum <- cumsum(exdfs$ext.end)


exdfs$perc.ext.rand.cum<-100-(exdfs$ext.rand.cum/590*100)

exdfs$perc.ext.deghigh.cum<-100-(exdfs$ext.deghigh.cum/590*100)

exdfs$perc.ext.deglow.cum<-100-((exdfs$ext.deglow.cum/590)*100)

exdfs$perc.ext.end.cum<-100-((exdfs$ext.end.cum/590)*100)


exdfs2 <- exdfs%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs3 <- exdfs%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 
curve_plot <- ggplot(data= exdfs2, aes(x= perc.no, y=perc.ext.rand))+
  ylab("% of trees surviving")+
  xlab("% of lemurs extinct")+
  theme_classic()+
  geom_point(color="black")+
  ylim(c(85,100))+
  geom_point(aes(x= perc.no, y=perc.ext.end), color="#D55E00")+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh), color="#56B4E9")+
  geom_point(aes(x= perc.no, y=perc.ext.deglow), color="E69F00")+
  geom_smooth(color="black")+
  geom_smooth(aes(x= perc.no, y=perc.ext.end), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh), color="56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow), color="E69F00")

curve_plot2 <- ggplot(data= exdfs3, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Trees With Interaction(s)")+
  xlab("% Lemurs Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.3)+
  geom_smooth(color="black")+
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))




# Calculate network level measures, connectance, compartments, nestedness
# The origional Network 
netres<-networklevel(bipart,  index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                     ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "random", 
                     nrep = 1, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                     logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                     fcdist="euclidean", legacy=FALSE)
netres
str(netres)

mod_hybrid1 <- computeModules(bipart[c(1:55),])
mod_hybrid1 <- mod_hybrid1@likelihood
mod_hybrid <- mod_hybrid1 

subgraph_net<- as.sociomatrix.sna(subgraph_reduced_all, attrname=NULL, simplify=TRUE, force.bipartite=FALSE)
netres_subgraph<-networklevel(web =subgraph_net,  index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                     ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "random", 
                     nrep = 1, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                     logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                     fcdist="euclidean", legacy=FALSE)
netres_subgraph


```

```{r Post-Extinction Hybrid Network - Lemur}

#Subgraph network so that it does not include EN or CR species
subgraph_nonthreatened<-get.inducedSubgraph(net,which(net%v%"Threat"=="LC"|net%v%"Threat"=="VU"|net%v%"type"=="tree"))
plot(subgraph_nonthreatened, displaylabels = F)
network.vertex.names(subgraph_nonthreatened)
subgraph_nonthreatened%v%"degree"<-sna::degree(subgraph_nonthreatened,cmode="indegree")
summary(subgraph_nonthreatened%v%"degree")
subgraph_nonthreatened2<-get.inducedSubgraph(subgraph_nonthreatened,which(subgraph_nonthreatened%v%"degree">0))
plot(subgraph_nonthreatened2, displaylabels = F)

bipart_0s_nothreat<-as.matrix.network(subgraph_nonthreatened2)
head(bipart_0s_nothreat[,1:10])
dim(bipart_0s_nothreat)

subgraph_threatened<-get.inducedSubgraph(net,which(net%v%"Threat"=="EN"|net%v%"Threat"=="CR"|net%v%"type"=="tree"))
network.vertex.names(subgraph_threatened)
subgraph_threatened%v%"degree"<-sna::degree(subgraph_threatened,cmode="indegree")
summary(subgraph_threatened%v%"degree")
subgraph_threatened2<-get.inducedSubgraph(subgraph_threatened,which(subgraph_threatened%v%"degree">0))
plot(subgraph_nonthreatened2, displaylabels = F)
threatened_degree <-as.data.frame(subgraph_threatened2%v%"degree")
colnames(threatened_degree) <- "degree"


##secondary extinction

# Scenario 1 
(ex_extinct <- second.extinct(bipart_0s_nothreat, participant="lower", method="random", nrep=21, 
                              details=F))
ex_extinct
summary(ex_extinct)
rob_ext_1<-robustness(ex_extinct)


# Scenario 2
(ex2_extinct <- second.extinct(bipart_0s_nothreat, participant="lower", method="degree", nrep=21, 
                               details=F))
ex2_extinct
summary(ex2_extinct)

rob_ext_2<-robustness(ex2_extinct)


# Scenario3 
net_threat<-network(bipart_0s_nothreat,bipartite=T,matrix.type="bipartite")
net_threat %v% "degree" <- sna::degree(net_threat,cmode="indegree")
degreedf2<-as.data.frame(net_threat%v%"degree")
dim(bipart_0s_nothreat)
degreedf2$node<-rownames(degreedf2)
degreedf2$name<-net_threat%v%"vertex.names"
degreedfhost2<-degreedf2[1:21,]
degreedfhost2<-sort(degreedfhost2)
as.numeric(degreedfhost2$node)

dim(degreedfhost2)
dim(bipart_0s_nothreat)
(ex3_extinct <- second.extinct(bipart_0s_nothreat, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost2$node), 
                       details=F))
ex3_extinct
summary(ex3_extinct)

rob_ext_3<-robustness(ex3_extinct)


#Scenario 4 
##order from first to last the species that are 1) most endangered and 2) smallest range
as.numeric(endangdflemur$node)
dim(bipart_0s_nothreat)
endangdflemur2<-endangdflemur[35:55,]
endangdflemur2<-endangdflemur2[order(endangdflemur2$area,-endangdflemur2$status),]
dim(endangdflemur2)
endangdflemur2$node <-as.numeric(endangdflemur2$node)
rownames(endangdflemur2) <- rep(1:21)
endangdflemur2$node <- rep(1:21)
(ex4_extinct <- second.extinct(bipart_0s_nothreat, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur2$node), 
                       details=F))
ex4_extinct
summary(ex4_extinct)
plot(ex4_extinct)
str(ex4_extinct)

rob_extinct_4<-robustness(ex4_extinct)



########connectance and other measures on the bipartite network
netres_extinct<-networklevel(bipart_0s_nothreat, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct 

mod_extinct <- computeModules(bipart_0s_nothreat)
mod_extinct <- mod_extinct@likelihood
mod_hybrid_extinct<- mod_extinct

as.data.frame(netres_extinct)

```

```{r Null model Hybrid Network - Lemur}

###test for phylo signal in threat status
vertextraits_ps <- vertextraits
vertextraits_ps$IUCN[vertextraits_ps$IUCN=="CR"]<- 1
vertextraits_ps$IUCN[vertextraits_ps$IUCN=="EN"]<- 1
vertextraits_ps$IUCN[vertextraits_ps$IUCN=="VU"]<- 0
vertextraits_ps$IUCN[vertextraits_ps$IUCN=="NT"]<- 0
vertextraits_ps$IUCN[vertextraits_ps$IUCN=="LC"]<- 0
vertextraits_ps<-vertextraits_ps[order(vertextraits_ps$IUCN_lemur),]
threatstat<-as.factor(vertextraits_ps$IUCN)
names(threatstat)<-vertextraits_ps$species
threatstat <- threatstat[1:55]

physigthreatlambder<-fitDiscrete(tree_l,threatstat,model="ER",transform="lambda")
physigthreatlambder 

physigthreatlambdaard<-fitDiscrete(tree_l,threatstat,model="ARD",transform="lambda")
physigthreatlambdaard

physigthreatwhiteer<-fitDiscrete(tree_l,threatstat,model="ER",transform="white")
physigthreatwhiteer 

#no phylogenetic signal 

net2<-net


netres_random<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              H2=NA, 
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA,
                              robust5=NA)

##add a simthreatomly assigned 0/1 variable with prob = the proportion of threatened species in the database
for(i in 1:100){
  set.seed(i)
  n<-55 
  rand<-rbinom(n,1,0.6181818)
  summary(as.factor(rand))
  obsthreat<-as.character(na.omit(vertextraits$IUCN))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net)[55:length(network.vertex.names(net))])))
  
  net2%v%"rand"<-rand
  summary(net2%v%"rand")
  
   subgraph_nonthreatened_rand<-get.inducedSubgraph(net2,which(net2%v%"rand"=="0"|net2%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand%v%"degree"<-sna::degree(subgraph_nonthreatened_rand,cmode="indegree")
  subgraph_nonthreatened_rand2<-get.inducedSubgraph(subgraph_nonthreatened_rand,which(subgraph_nonthreatened_rand%v%"degree">0))
  
  bipart_0s_nothreat_rand<-as.matrix.network(subgraph_nonthreatened_rand2)
  
  
  (ex_rand <- second.extinct(bipart_0s_nothreat_rand, participant="lower", method="random", nrep=dim(bipart_0s_nothreat_rand)[1], 
                             details=F))
  ex_rand
  rob_rand1<-robustness(ex_rand)
  
  
  (ex2_rand <- second.extinct(bipart_0s_nothreat_rand, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_rand)[1], 
                              details=F))
  ex2_rand
  summary(ex2_rand)
  
  rob_rand2<-robustness(ex2_rand) 
 
  
#Scenario 3 
degreedf3<-as.data.frame(subgraph_nonthreatened_rand2%v%"degree")
degreedf3$node<-rownames(degreedf3)
degreedf3$name<-subgraph_nonthreatened_rand2%v%"vertex.names"
degreedfhost3<-degreedf3[1:as.numeric(nrow(bipart_0s_nothreat_rand)[1]),]
degreedfhost3<-sort(degreedfhost3)
as.numeric(degreedfhost3$node)

(ex3_rand <- second.extinct(bipart_0s_nothreat_rand, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3$node), 
                       details=F))
ex3_rand
summary(ex3_rand)

rob_rand_3<-robustness(ex3_rand) 

#Scenario 4
dim(bipart_0s_nothreat_rand)
endangdflemur4<-endangdflemur[(56-as.numeric(nrow(bipart_0s_nothreat_rand)[1])):55,]
endangdflemur4<-endangdflemur2[order(-endangdflemur4$status,endangdflemur4$area),]
dim(endangdflemur4)
endangdflemur4$node <-as.numeric(endangdflemur4$node)
rownames(endangdflemur4) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand)[1]))
endangdflemur4$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand)[1]))
(ex4_rand <- second.extinct(bipart_0s_nothreat_rand, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur4$node), 
                       details=F))
ex4_rand
summary(ex4_rand)
plot(ex4_rand)
str(ex4_rand)

rob_rand4<-robustness(ex4_rand)

# Scenario 1 repeated 

(ex_rand5 <- second.extinct(bipart_0s_nothreat_rand, participant="lower", method="random", dim(bipart_0s_nothreat_rand)[1], 
                      details=F))
  
  ex_rand5
  rob_rand5<-robustness(ex_rand5)

  
  ###network level results
  netres_extinct_rand <-networklevel(bipart_0s_nothreat_rand, index=c("connectance","number of compartments","nestedness","H2"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  

  netres_random[i,]<-cbind(as.data.frame(t(netres_extinct_rand)),rob_rand1 ,rob_rand2, rob_rand_3, rob_rand4, rob_rand5)
}

summary(netres_random)



min(netres_random$connectance)
max(netres_random$connectance)
median(netres_random$connectance)

min(netres_random$nest)
max(netres_random$nest)
median(netres_random$nest)

min(netres_random$robust1)
max(netres_random$robust1)
median(netres_random$robust1)

min(netres_random$robust2)
max(netres_random$robust2)
median(netres_random$robust2)

min(netres_random$robust3)
max(netres_random$robust3)
median(netres_random$robust3)

min(netres_random$robust4)
max(netres_random$robust4)
median(netres_random$robust4)


#compute p-values

p.con <- prop(~connectance >= netres[1], data= netres_random)
p.con2 <- prop(~connectance <= netres[1], data= netres_random)  
p.con_ex <- prop(~connectance >= netres_extinct[1], data= netres_random)
p.con_ex2 <- prop(~connectance <= netres_extinct[1], data= netres_random)  

p.nest <- prop(~nest >= netres[3], data= netres_random)
p.nest2 <- prop(~nest <= netres[3], data= netres_random)  
p.nest_ex <- prop(~nest >= netres_extinct[3], data= netres_random)
p.nest_ex2 <- prop(~nest <= netres_extinct[3], data= netres_random) 

p.rob1 <- prop(~robust1 >= rob1, data= netres_random)
p.rob12 <- prop(~robust1 <= rob1, data= netres_random)  
p.rob1_ex <- prop(~robust1 >= rob_ext_1, data= netres_random)
p.rob1_ex2 <- prop(~robust1  <= rob_ext_1, data= netres_random) 

p.rob2 <- prop(~robust2 >= rob2, data= netres_random)
p.rob22 <- prop(~robust2 <= rob2, data= netres_random)  
p.rob2_ex <- prop(~robust2 >= rob_ext_2, data= netres_random)
p.rob2_ex2 <- prop(~robust2  <= rob_ext_2, data= netres_random) 

p.rob3 <- prop(~robust3 >= rob3, data= netres_random)
p.rob32 <- prop(~robust3 <= rob3, data= netres_random)  
p.rob3_ex <- prop(~robust3 >= rob_ext_3, data= netres_random)
p.rob3_ex2 <- prop(~robust3  <= rob_ext_3, data= netres_random) 

p.rob4 <- prop(~robust4 >= rob4, data= netres_random)
p.rob42 <- prop(~robust4 <= rob4, data= netres_random)  
p.rob4_ex <- prop(~robust4 >= rob_extinct_4, data= netres_random)
p.rob4_ex2 <- prop(~robust4  <= rob_extinct_4, data= netres_random) 

netres_random2 <- netres_random%>%
  pivot_longer(cols = c(5:8), values_to= "Robustness", names_to ="Scenario")%>%
   mutate(Scenario = factor(Scenario, levels=c("robust5", "robust2", "robust3", "robust4")))

ggplot(data= netres_random2, aes(y=Robustness, x= Scenario))+
  geom_boxplot()+
  theme_classic()+
  scale_x_discrete(labels=c("robust5" = "Random", "robust2" = "Degree High-Low",
                              "robust3" = "Degree Low-High", "robust4" = "Extinction Likelihood"))


```

```{r Modularity hybrid lemur null model}

net2<-net

mod_random<-data.frame(mod = NA)

##add a simthreatomly assigned 0/1 variable with prob = the proportion of threatened species in the database
for(i in 1:100){
  set.seed(i)
  n<-55 
  rand<-rbinom(n,1,0.6181818)
  summary(as.factor(rand))
  obsthreat<-as.character(na.omit(vertextraits$IUCN))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net)[55:length(network.vertex.names(net))])))
  
  net2%v%"rand"<-rand
  summary(net2%v%"rand")
  
   subgraph_nonthreatened_rand<-get.inducedSubgraph(net2,which(net2%v%"rand"=="0"|net2%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand%v%"degree"<-sna::degree(subgraph_nonthreatened_rand,cmode="indegree")
  subgraph_nonthreatened_rand2<-get.inducedSubgraph(subgraph_nonthreatened_rand,which(subgraph_nonthreatened_rand%v%"degree">0))
  
  bipart_0s_nothreat_rand<-as.matrix.network(subgraph_nonthreatened_rand2)
  
mod <- computeModules(bipart_0s_nothreat_rand)
mod2 <- mod@likelihood

  mod_random[i,]<-cbind(mod2)
}

mod_random <- as.data.frame(mod_random)
write.csv(mod_random, "mod_random.csv")

min(mod_random)
max(mod_random)
median(mod_random$mod)

p.value_mod_hy <- prop(~mod >= mod_hybrid, data= mod_random)
p.value_mod_hy2 <- prop(~mod <= mod_hybrid, data= mod_random)
p.value_mod_hy_ex <- prop(~mod >= mod_hybrid_extinct, data= mod_random)
p.value_mod_hy_ex2 <- prop(~mod <= mod_hybrid_extinct, data= mod_random)

summary(mod_random)

```

#Hybrid Tree Extinctions 

```{r Original Hybrid Network - Tree}
#secondary extinction
# using random removal of trees, what is the average number of secondary extinctions 
bipart2[is.na(bipart2)] <- 0

bipart3 <- t(bipart)
bipart3[is.na(bipart3)] <- 0
dim(bipart3)

# Scienario 1: Random 
(ex_t <- second.extinct(bipart3, participant="lower", method="random", nrep=590, 
                      details=F))
ex_t
summary(ex_t)
plot(ex_t)
rob1_t<-robustness(ex_t)

exdf_t<-as.data.frame(ex_t[1:590,])
plot(exdf_t$ext.higher~exdf_t$no)


# Scenario 2: removal of trees from highest to lowest degree
(ex2_t <- second.extinct(bipart3, participant="lower", method="degree", nrep=590, 
                       details=F))
ex2_t
summary(ex2_t)
plot(ex2_t)
str(ex2_t)

ex2df_t<-as.data.frame(ex2_t[1:590,])
plot(ex2df_t$ext.higher~ex2df_t$no)

rob2_t<-robustness(ex2_t)


#Scenario 3: remove lemurs from lowest to highest degree

degreedf_t<-as.data.frame(net%v%"degree")
degreedf_t$node<-rownames(degreedf_t)
degreedf_t$name<-net%v%"vertex.names"
degreedfhost_t<-degreedf_t[56:645,]
degreedfhost_t<-sort(degreedfhost_t)
degreedfhost_t$node <-as.numeric(degreedfhost_t$node)
degreedfhost_t$node2 <- degreedfhost_t$node - 55
dim(degreedfhost_t)
dim(bipart3)

(ex3_t <- second.extinct(bipart3, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost_t$node2), 
                       details=F))
ex3_t
summary(ex3_t)
plot(ex3_t)
str(ex3_t)

ex3df_t<-as.data.frame(ex3_t[1:590,])
plot(ex3df_t$ext.higher~ex3df_t$no)

rob3_t<-robustness(ex3_t)

#Scenario 4: Remove lemurs according to extinction likelihood 
vertextraits_ps$IUCN_tree <- vertextraits_ps$mIUCN
vertextraits_ps$IUCN_tree[51:680]

endangdf_t<-data.frame(
                     name=net%v%"vertex.names",
                     Threat=net%v%"iucn")
endangdf_t <-endangdf_t[56:645,]
endangdf_t$status <- endangdf_t$Threat

endangdf_t$node<-rownames(endangdf_t)
endangdftree<-endangdf_t
head(endangdftree)
endangdftree$status <- as.numeric(endangdftree$status)
dim(endangdftree)
endangdftree$node <- as.numeric(endangdftree$node)
endangdftree$node2 <- endangdftree$node -55

##order from first to last the species that are most endangered
endangdftree < -endangdftree[order(-endangdftree$status),]
dim(endangdftree)
dim(bipart3)

as.numeric(endangdftree$node2)

(ex4_t <- second.extinct(bipart3, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree$node2), 
                       details=F))
ex4_t
summary(ex4_t)
plot(ex4_t)
str(ex4_t)

rob4_t <- robustness(ex4_t)

ex4df_t<-as.data.frame(ex4_t[1:590,])
plot(ex4df_t$ext.higher~ex4df_t$no)

#combine the different extinction scenarios
exdfs_t<-cbind(exdf_t,ex2df_t,ex3df_t,ex4df_t)
colnames(exdfs_t)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
summary(exdfs_t)
##convert to %
exdfs_t$perc.no<-exdfs_t$no/590*100
exdfs_t$perc.ext.rand<-100-(exdfs_t$ext.rand/55*100)
exdfs_t$perc.ext.deghigh<-100-(exdfs_t$ext.deghigh/55*100)
exdfs_t$perc.ext.deglow<-100-(exdfs_t$ext.deglow/55*100)
exdfs_t$perc.ext.end<-100-(exdfs_t$ext.end/55*100)

exdfs_t$ext.rand.cum <- cumsum(exdfs_t$ext.rand)
exdfs_t$ext.deghigh.cum <- cumsum(exdfs_t$ext.deghigh)
exdfs_t$ext.deglow.cum <- cumsum(exdfs_t$ext.deglow)
exdfs_t$ext.end.cum <- cumsum(exdfs_t$ext.end)


exdfs_t$perc.ext.rand.cum<-100-(exdfs_t$ext.rand.cum/55*100)

exdfs_t$perc.ext.deghigh.cum<-100-(exdfs_t$ext.deghigh.cum/55*100)

exdfs_t$perc.ext.deglow.cum<-100-((exdfs_t$ext.deglow.cum/55)*100)

exdfs_t$perc.ext.end.cum<-100-((exdfs_t$ext.end.cum/55)*100)

exdfs2_t <- exdfs_t%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs2_t2 <- exdfs_t%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 
curve_plot_t <- ggplot(data= exdfs2_t, aes(x= perc.no, y=perc.ext.rand))+
  ylab("% of lemurs surviving")+
  xlab("% of trees extinct")+
  theme_classic()+
  geom_point(color="black")+
  ylim(c(85,100))+
  geom_point(aes(x= perc.no, y=perc.ext.end), color="red")+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh), color="purple")+
  geom_point(aes(x= perc.no, y=perc.ext.deglow), color="orange")

#plot all of the extinction scenarios 
curve_plot_t2 <- ggplot(data= exdfs2_t2, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Lemurs With Interaction(s)")+
  xlab("% Trees Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.1)+
  geom_smooth(color="black")+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.1)+  
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))

curve_plots <- ggarrange(curve_plot2, curve_plot_t2, labels = c("A", "B"), legend = )
curve_plots_fruit

```

```{r Post-Extinction Hybrid Network - Tree}

plants_extinct <- vertextraits %>%
  filter(mIUCN ==4|mIUCN==5)
dim(plants_extinct)

#Subgraph network so that it does not include EN or CR species
subgraph_nonthreatened_t<-get.inducedSubgraph(net,which(net%v%"iucn"=="1"|net%v%"iucn"=="2"|net%v%"iucn"=="3"|net%v%"type"=="lemur"|is.na(net%v%"iucn")))
plot(subgraph_nonthreatened_t, displaylabels = F)
network.vertex.names(subgraph_nonthreatened_t)
subgraph_nonthreatened_t%v%"degree"<-sna::degree(subgraph_nonthreatened_t,cmode="indegree")
summary(subgraph_nonthreatened_t%v%"degree")
subgraph_nonthreatened2_t<-get.inducedSubgraph(subgraph_nonthreatened_t,which(subgraph_nonthreatened_t%v%"degree">0))
plot(subgraph_nonthreatened2_t, displaylabels = F)

bipart_0s_nothreat_t<-as.matrix.network(subgraph_nonthreatened2_t)
bipart_0s_nothreat_t <- t(bipart_0s_nothreat_t)
head(bipart_0s_nothreat_t[,1:10])
dim(bipart_0s_nothreat_t)

subgraph_nonthreatened2_t%v%"type"=="lemur"
nonthreatened_degree_t <-as.data.frame(subgraph_nonthreatened2_t%v%"degree")
colnames(nonthreatened_degree_t) <- "degree"
nonthreatened_degree_t_lem <-nonthreatened_degree_t[1:55,]
nonthreatened_degree_t_tree <-threatened_degree[-c(1:55),]
mean(nonthreatened_degree_t_lem)
mean(nonthreatened_degree_t_tree)
sd(nonthreatened_degree_t_lem)

subgraph_threatened_t<-get.inducedSubgraph(subgraph_reduced_iucn,which(subgraph_reduced_iucn%v%"iucn"=="4"|subgraph_reduced_iucn%v%"iucn"=="4"|subgraph_reduced_iucn%v%"type"=="lemur"))
subgraph_threatened_t%v%"degree"<-sna::degree(subgraph_threatened_t,cmode="indegree")
subgraph_threatened2_t<-get.inducedSubgraph(subgraph_threatened_t,which(subgraph_threatened_t%v%"degree">0))
threatened_degree_t <-as.data.frame(subgraph_threatened2_t%v%"degree")
colnames(threatened_degree_t) <- "degree"
threatened_degree_t_lem <-threatened_degree_t[1:55,]
threatened_degree_t_tree <-threatened_degree[-c(1:55),]
mean(threatened_degree_t_lem)
mean(threatened_degree_t_tree)
sd(threatened_degree_t_lem)
##secondary extinction

# Scenario 1 
(ex_extinct_t <- second.extinct(bipart_0s_nothreat_t, participant="lower", method="random", nrep=109, 
                              details=F))
ex_extinct_t
summary(ex_extinct_t)
rob_ext_1_t<-robustness(ex_extinct_t)


# Scenario 2
(ex2_extinct_t <- second.extinct(bipart_0s_nothreat_t, participant="lower", method="degree", nrep=109, 
                               details=F))
ex2_extinct_t
summary(ex2_extinct_t)

rob_ext_2_t<-robustness(ex2_extinct_t)#0.6661833


# Scenario3 

net_threat_t<-network(bipart_0s_nothreat_t,bipartite=T,matrix.type="bipartite")
dim(bipart_0s_nothreat_t)
net_threat_t %v% "degree" <- sna::degree(net_threat_t,cmode="indegree")
degreedf2_t<-as.data.frame(net_threat_t%v%"degree")
degreedf2_t$node<-rownames(degreedf2_t)
degreedf2_t$name<-net_threat_t%v%"vertex.names"
degreedf2_t$node <- as.numeric(degreedf2_t$node)
degreedf2_t$node <- sort(degreedf2_t$node)
dim(bipart_0s_nothreat_t)
dim(degreedf2_t)
degreedf2_t<-degreedf2_t[1:545,]
degreedf2_t<-sort(degreedf2_t)
as.numeric(degreedf2_t$node)

dim(degreedf2_t)
dim(bipart_0s_nothreat_t)

(ex3_extinct_t <- second.extinct(bipart_0s_nothreat_t, participant="lower", method="external",ext.row=as.numeric(degreedf2_t$node), 
                       details=F))
ex3_extinct_t
summary(ex3_extinct_t)

rob_ext_3_t<-robustness(ex3_extinct_t) #0.9732548 


#Scenario 4 
##order from first to last the species that are most endangered

as.numeric(endangdftree$node2)
dim(bipart_0s_nothreat_t)
endangdftree<-endangdftree[order(-endangdftree$status),]
endangdftree <- drop_na(endangdftree, status)
endangdftree<-endangdftree[1:545,]
dim(endangdftree)
endangdftree$node <-as.numeric(endangdftree$node)
rownames(endangdftree) <- rep(1:545)
endangdftree$node <- rep(1:545)

(ex4_extinct_t <- second.extinct(bipart_0s_nothreat_t, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree$node), 
                       details=F))
ex4_extinct_t
summary(ex4_extinct_t)
plot(ex4_extinct_t)
str(ex4_extinct_t)

rob_extinct_4_t<-robustness(ex4_extinct_t)



########connectance and other measures on the bipartite network
netres_extinct_t<-networklevel(bipart_0s_nothreat_t, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct_t #conn=0.1062706 ; #comparts=2; nestedness =  7.7152367 

mod_extinct_t <- computeModules(bipart_0s_nothreat_t)
mod_extinct_t <- mod_extinct_t@likelihood


as.data.frame(netres_extinct_t)

```

```{r Modularity Null model Hybrid Network - Tree}

net2 <- net

mod_random_phy_t<-data.frame(mod=NA)

for(i in 1:100){
  #set.seed(i)
   n <- 590
  rand_t<-rbinom(n,1,0.07627119)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",55), rand_t)
  
  net2%v%"rand_t"<-rand_t
  summary(net2%v%"rand_t")
  
   subgraph_nonthreatened_rand_t<-get.inducedSubgraph(net2,which(net2%v%"rand_t"=="0"|net2%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t,cmode="indegree")
  subgraph_nonthreatened_rand2_t<-get.inducedSubgraph(subgraph_nonthreatened_rand_t,which(subgraph_nonthreatened_rand_t%v%"degree">0))
  
  bipart_0s_nothreat_rand_t<-as.matrix.network(subgraph_nonthreatened_rand2_t)
  dim(bipart_0s_nothreat_rand_t)
  
bipart_0s_nothreat_rand_t2 <- t(bipart_0s_nothreat_rand_t)
bipart_0s_nothreat_rand_t2[is.na(bipart_0s_nothreat_rand_t2)] <- 0
dim(bipart_0s_nothreat_rand_t2)
  
mod_extinct_t <- computeModules(bipart_0s_nothreat_rrand_t2)
mod2_extinct_t <- mod_extinct_t@likelihood
  
  mod_random_phy_t[i,]<-cbind(mod2_extinct_t)
}

mod_random_phy_t
write.csv(mod_random_phy_t, "mod_random_phy_t.csv")
summary(mod_random_phy_t) 


min(mod_random_phy_t)
max(mod_random_phy_t)
median(mod_random_phy_t$mod)

p.value_mod_hy_t <- prop(~mod >= mod_hybrid, data= mod_random_phy_t)
p.value_mod_hy2_t <- prop(~mod <= mod_hybrid, data= mod_random_phy_t)
p.value_mod_hy_ex_t <- prop(~mod >= mod2_extinct_t, data= mod_random_phy_t)
p.value_mod_hy_ex2_t <- prop(~mod <= mod2_extinct_t, data= mod_random_phy_t)


```

Break up Null model Hybrid Network Tree analyses into three parts because these calculations are very computationally-intensive
```{r Null model Hybrid Network - Tree 1-51}

net2<-net

netres_random_phy_t<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA, 
                              mod =NA)

##add a simthreatomly assigned 0/1 variable with prob = the proportion of threatened species in the database
for(i in 1:100){
  set.seed(i)
   n <- 590
  rand_t<-rbinom(n,1,0.07627119)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",55), rand_t)
  
  net2%v%"rand_t"<-rand_t
  summary(net2%v%"rand_t")
  
   subgraph_nonthreatened_rand_t<-get.inducedSubgraph(net2,which(net2%v%"rand_t"=="0"|net2%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t,cmode="indegree")
  subgraph_nonthreatened_rand2_t<-get.inducedSubgraph(subgraph_nonthreatened_rand_t,which(subgraph_nonthreatened_rand_t%v%"degree">0))
  
  bipart_0s_nothreat_rand_t<-as.matrix.network(subgraph_nonthreatened_rand2_t)
  dim(bipart_0s_nothreat_rand_t)
  
  bipart_0s_nothreat_rand_t2 <- t(bipart_0s_nothreat_rand_t)
bipart_0s_nothreat_rand_t2[is.na(bipart_0s_nothreat_rand_t2)] <- 0
dim(bipart_0s_nothreat_rand_t2)

  
  
  (ex_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="random", nrep=as.numeric(nrow(bipart_0s_nothreat_rand_t2)), 
                             details=F))

  rob_rand1_t<-robustness(ex_rand_t) 
  
  (ex2_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_t)[1], 
                              details=F))

  rob_rand2_t<-robustness(ex2_rand_t) 
 
#Scenario 3 

degreedf3_t<-as.data.frame(subgraph_nonthreatened_rand2_t%v%"degree")
degreedf3_t$node<-rownames(degreedf3_t)
degreedf3_t$name<-subgraph_nonthreatened_rand2_t%v%"vertex.names"
degreedfhost3_t<-degreedf3_t[-c(1:as.numeric(ncol(bipart_0s_nothreat_rand_t2))),]
degreedfhost3_t<-sort(degreedfhost3_t)
degreedfhost3_t$node2 <- as.numeric(degreedfhost3_t$node)-as.numeric(ncol(bipart_0s_nothreat_rand_t2))



(ex3_extinct_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_t$node2), 
                       details=F))

rob_rand3_t<-robustness(ex3_extinct_rand_t) 

#Scenario 4 
##order from first to last the species that are most endangered
endangdf_t<-endangdf_t[order(-as.numeric(endangdf_t$status)),]
tree_names<- as.data.frame(rownames(bipart_0s_nothreat_rand_t2))
colnames(tree_names) <- "name"
endangdftree2 <- left_join(tree_names, endangdf_t)
rownames(endangdftree2) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))
endangdftree2$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))

(ex4_rand_t <- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2$node), 
                       details=F))
rob_rand4_t<-robustness(ex4_rand_t)


  
  ###network level results
  netres_extinct_rand_t <-networklevel(bipart_0s_nothreat_rand_t2, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
g_hybrid_rand_t <- igraph::graph.incidence(bipart_0s_nothreat_rand_t2)
wtc_hybrid_rand_t <- cluster_walktrap(g_hybrid_rand_t)
mod <- modularity(wtc_hybrid_rand_t)

  
  netres_random_phy_t[i,]<-cbind(as.data.frame(t(netres_extinct_rand_t)),rob_rand1_t, rob_rand2_t, rob_rand3_t, rob_rand4_t, mod)
}

netres_random_phy_t51 <- netres_random_phy_t
summary(netres_random_phy_t51)



```

```{r Null model Hybrid Network - Tree 53-69}

net2<-net

netres_random_phy_t2<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)
for(i in 53:101){
  set.seed(i)
   n <- 590
  rand_t<-rbinom(n,1,0.07627119)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",55), rand_t)
  
  net2%v%"rand_t"<-rand_t
  summary(net2%v%"rand_t")
  
   subgraph_nonthreatened_rand_t<-get.inducedSubgraph(net2,which(net2%v%"rand_t"=="0"|net2%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t,cmode="indegree")
  subgraph_nonthreatened_rand2_t<-get.inducedSubgraph(subgraph_nonthreatened_rand_t,which(subgraph_nonthreatened_rand_t%v%"degree">0))
  
  bipart_0s_nothreat_rand_t<-as.matrix.network(subgraph_nonthreatened_rand2_t)
  dim(bipart_0s_nothreat_rand_t)
  
  bipart_0s_nothreat_rand_t2 <- t(bipart_0s_nothreat_rand_t)
bipart_0s_nothreat_rand_t2[is.na(bipart_0s_nothreat_rand_t2)] <- 0
dim(bipart_0s_nothreat_rand_t2)

  
  
  (ex_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="random", nrep=as.numeric(nrow(bipart_0s_nothreat_rand_t2)), 
                             details=F))

  rob_rand1_t<-robustness(ex_rand_t) 
  
  (ex2_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_t)[1], 
                              details=F))

  rob_rand2_t<-robustness(ex2_rand_t) 
 
#Scenario 3 

degreedf3_t<-as.data.frame(subgraph_nonthreatened_rand2_t%v%"degree")
degreedf3_t$node<-rownames(degreedf3_t)
degreedf3_t$name<-subgraph_nonthreatened_rand2_t%v%"vertex.names"
degreedfhost3_t<-degreedf3_t[-c(1:as.numeric(ncol(bipart_0s_nothreat_rand_t2))),]
degreedfhost3_t<-sort(degreedfhost3_t)
degreedfhost3_t$node2 <- as.numeric(degreedfhost3_t$node)-as.numeric(ncol(bipart_0s_nothreat_rand_t2))



(ex3_extinct_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_t$node2), 
                       details=F))

rob_rand3_t<-robustness(ex3_extinct_rand_t) 

#Scenario 4 
##order from first to last the species that are most endangered
endangdf_t<-endangdf_t[order(-as.numeric(endangdf_t$status)),]
tree_names<- as.data.frame(rownames(bipart_0s_nothreat_rand_t2))
colnames(tree_names) <- "name"
endangdftree2 <- left_join(tree_names, endangdf_t)
rownames(endangdftree2) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))
endangdftree2$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))

(ex4_rand_t <- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2$node), 
                       details=F))
rob_rand4_t<-robustness(ex4_rand_t)


  
  ###network level results
  netres_extinct_rand_t <-networklevel(bipart_0s_nothreat_rand_t2, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
  netres_random_phy_t2[i,]<-cbind(as.data.frame(t(netres_extinct_rand_t)),rob_rand1_t, rob_rand2_t, rob_rand3_t, rob_rand4_t)
}

summary(netres_random_phy_t2)
```

```{r Null model Hybrid Network - Tree 71-102}

net2<-net

netres_random_phy_t3<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)

for(i in 71:102){
  set.seed(i)
   n <- 590
  rand_t<-rbinom(n,1,0.07627119)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",55), rand_t)
  
  net2%v%"rand_t"<-rand_t
  summary(net2%v%"rand_t")
  
   subgraph_nonthreatened_rand_t<-get.inducedSubgraph(net2,which(net2%v%"rand_t"=="0"|net2%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t,cmode="indegree")
  subgraph_nonthreatened_rand2_t<-get.inducedSubgraph(subgraph_nonthreatened_rand_t,which(subgraph_nonthreatened_rand_t%v%"degree">0))
  
  bipart_0s_nothreat_rand_t<-as.matrix.network(subgraph_nonthreatened_rand2_t)
  dim(bipart_0s_nothreat_rand_t)
  
  bipart_0s_nothreat_rand_t2 <- t(bipart_0s_nothreat_rand_t)
bipart_0s_nothreat_rand_t2[is.na(bipart_0s_nothreat_rand_t2)] <- 0
dim(bipart_0s_nothreat_rand_t2)

  
  
  (ex_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="random", nrep=as.numeric(nrow(bipart_0s_nothreat_rand_t2)), 
                             details=F))

  rob_rand1_t<-robustness(ex_rand_t) 
  
  (ex2_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_t)[1], 
                              details=F))

  rob_rand2_t<-robustness(ex2_rand_t) 
 
#Scenario 3 

degreedf3_t<-as.data.frame(subgraph_nonthreatened_rand2_t%v%"degree")
degreedf3_t$node<-rownames(degreedf3_t)
degreedf3_t$name<-subgraph_nonthreatened_rand2_t%v%"vertex.names"
degreedfhost3_t<-degreedf3_t[-c(1:as.numeric(ncol(bipart_0s_nothreat_rand_t2))),]
degreedfhost3_t<-sort(degreedfhost3_t)
degreedfhost3_t$node2 <- as.numeric(degreedfhost3_t$node)-as.numeric(ncol(bipart_0s_nothreat_rand_t2))



(ex3_extinct_rand_t<- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_t$node2), 
                       details=F))

rob_rand3_t<-robustness(ex3_extinct_rand_t)

#Scenario 4 
##order from first to last the species that are most endangered
endangdf_t<-endangdf_t[order(-as.numeric(endangdf_t$status)),]
tree_names<- as.data.frame(rownames(bipart_0s_nothreat_rand_t2))
colnames(tree_names) <- "name"
endangdftree2 <- left_join(tree_names, endangdf_t)
rownames(endangdftree2) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))
endangdftree2$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2)[1]))

(ex4_rand_t <- second.extinct(bipart_0s_nothreat_rand_t2, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2$node), 
                       details=F))
rob_rand4_t<-robustness(ex4_rand_t)


  
  ###network level results
  netres_extinct_rand_t <-networklevel(bipart_0s_nothreat_rand_t2, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
  netres_random_phy_t3[i,]<-cbind(as.data.frame(t(netres_extinct_rand_t)),rob_rand1_t, rob_rand2_t, rob_rand3_t, rob_rand4_t)
}

summary(netres_random_phy_t3)

netres_random_phy_t1 <-netres_random_phy_t51%>% 
  select(connectance:robust4)

#combine the three data sets
netres_random_phy_t_combined <- rbind(netres_random_phy_t3, netres_random_phy_t2, netres_random_phy_t1)


#calculate p values 
p.value <- prop(~connectance >= netres[1], data= netres_random_phy_t_combined)
p.value <- prop(~connectance <= netres[1], data= netres_random_phy_t_combined)  
p.value <- prop(~connectance >= netres_extinct_t[1], data= netres_random_phy_t_combined)
p.value <- prop(~connectance <= netres_extinct_t[1], data= netres_random_phy_t_combined)  

p.value <- prop(~comps >= netres[2], data= netres_random_phy_t_combined)
p.value <- prop(~comps <= netres[2], data= netres_random_phy_t_combined)  
p.value <- prop(~comps >= netres_extinct_t[2], data= netres_random_phy_t_combined)
p.value <- prop(~comps <= netres_extinct_t[2], data= netres_random_phy_t_combined)  

p.value <- prop(~nest >= netres[3], data= netres_random_phy_t_combined)
p.value <- prop(~nest  <= netres[3], data= netres_random_phy_t_combined)  
p.value <- prop(~nest  >= netres_extinct_t[3], data= netres_random_phy_t_combined)
p.value <- prop(~nest  <= netres_extinct_t[3], data= netres_random_phy_t_combined) 

p.value <- prop(~robust1 >= rob1_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust1  <= rob1_t, data= netres_random_phy_t_combined)  
p.value <- prop(~robust1  >= rob_ext_1_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust1  <= rob_ext_1_t, data= netres_random_phy_t_combined) 

p.value <- prop(~robust2 >= rob2_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust2  <= rob2_t, data= netres_random_phy_t_combined)  
p.value <- prop(~robust2  >= rob_ext_2_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust2  <= rob_ext_2_t, data= netres_random_phy_t_combined) 

p.value <- prop(~robust3 >= rob3_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust3  <= rob3_t, data= netres_random_phy_t_combined)  
p.value <- prop(~robust3  >= rob_ext_3_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust3  <= rob_ext_3_t, data= netres_random_phy_t_combined) 

p.value <- prop(~robust4 >= rob4_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust4  <= rob4_t, data= netres_random_phy_t_combined)  
p.value <- prop(~robust4  >= rob_extinct_4_t, data= netres_random_phy_t_combined)
p.value <- prop(~robust4  <= rob_extinct_4_t, data= netres_random_phy_t_combined) 

```

#Mutualistic Lemur Extinctions

```{r Original Mutualistic Network - Lemur}
#secondary extinction

dim(bipart_frugivore)
bipart_frugivore <- bipart_frugivore[-20,]
bipart_frugivore <- bipart_frugivore[-31,]

# Scienario 1: Random 
(ex_fruit <- second.extinct(bipart_frugivore, participant="lower", method="random", nrep=43, 
                      details=F))
ex_fruit 
summary(ex_fruit )
plot(ex_fruit )
rob1_fruit <-robustness(ex_fruit)

exdf_fruit<-as.data.frame(ex_fruit[1:43,])
plot(exdf_fruit$ext.higher~exdf_fruit$no)


# Scenario 2: removal of lemurs from highest to lowest degree
(ex2_fruit <- second.extinct(bipart_frugivore, participant="lower", method="degree", nrep=43, 
                       details=F))
ex2_fruit
ex2df_fruit<-as.data.frame(ex2_fruit[1:43,])
plot(ex2df_fruit$ext.higher~ex2df_fruit$no)

rob2_fruit<-robustness(ex2_fruit)


#Scenario 3: remove lemurs from lowest to highest degree
net_frugivore <-network(bipart_frugivore,bipartite=T,matrix.type="bipartite")

net_frugivore %v% "degree" <- sna::degree(net_frugivore,cmode="indegree")

degreedf_fruit<-as.data.frame(net_frugivore%v%"degree")
degreedf_fruit$node<-rownames(degreedf_fruit)
degreedf_fruit$name<-net_frugivore%v%"vertex.names"
degreedfhost_fruit<-degreedf_fruit[1:43,]
degreedfhost_fruit<-sort(degreedfhost_fruit)
degreedfhost_fruit$node <-as.numeric(degreedfhost_fruit$node)

(ex3_fruit <- second.extinct(bipart_frugivore, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost_fruit$node), 
                       details=F))

ex3df_fruit<-as.data.frame(ex3_fruit[1:43,])
plot(ex3df_fruit$ext.higher~ex3df_fruit$no)

rob3_fruit<-robustness(ex3_fruit)

#Scenario 4: Remove lemurs according to extinction likelihood 

colnames(vertextraits_frugivore)

area2_frugivore<- area2[net_frugivore %v% 'vertex.names']

 network::set.vertex.attribute(net_frugivore,"area",area2)
 network::get.vertex.attribute(net_frugivore,"area")
 
 
Threat_fruit<- as.character(vertextraits$IUCN_lemur)
names(Threat_fruit) <- vertextraits$species
Threat_fruit <- Threat_fruit[net_frugivore %v% 'vertex.names']
network::set.vertex.attribute(net_frugivore,"Threat",Threat_fruit)
network::get.vertex.attribute(net_frugivore,"Threat")
 
endangdf_fruit<-data.frame(area=net_frugivore%v%"area",
                     name=net_frugivore%v%"vertex.names",
                     Threat=net_frugivore%v%"Threat")
endangdf_fruit <-endangdf_fruit[1:43,]


endangdf_fruit$status <- as.numeric(endangdf_fruit$Threat)


##order from first to last the species that are 1) most endangered and 2) smallest range
endangdflemur_fruit<-endangdf_fruit[order(-endangdf_fruit$status,endangdf_fruit$area),]


endangdflemur_fruit$node<-rep(1:43)


endangdflemur_fruit <- endangdflemur_fruit[1:43,]

(ex4_fruit <- second.extinct(bipart_frugivore, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur_fruit$node), 
                       details=F))
ex4_fruit
summary(ex4_fruit)

rob4_fruit <-robustness(ex4_fruit)

ex4df_fruit<-as.data.frame(ex4_fruit[1:43,])
plot(ex4df_fruit$ext.higher~ex4df_fruit$no)

#combine the different extinction scenarios
exdfs_fruit<-cbind(exdf_fruit,ex2df_fruit,ex3df_fruit,ex4df_fruit)
colnames(exdfs_fruit)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
summary(exdfs_fruit)
##convert to %
exdfs_fruit$perc.no<-exdfs_fruit$no/43*100
exdfs_fruit$perc.ext.rand<-100-(exdfs_fruit$ext.rand/379*100)
exdfs_fruit$perc.ext.deghigh<-100-(exdfs_fruit$ext.deghigh/379*100)
exdfs_fruit$perc.ext.deglow<-100-((exdfs_fruit$ext.deglow/379)*100)
exdfs_fruit$perc.ext.end<-100-((exdfs_fruit$ext.end/379)*100)

exdfs_fruit$ext.rand.cum <- cumsum(exdfs_fruit$ext.rand)
exdfs_fruit$ext.deghigh.cum <- cumsum(exdfs_fruit$ext.deghigh)
exdfs_fruit$ext.deglow.cum <- cumsum(exdfs_fruit$ext.deglow)
exdfs_fruit$ext.end.cum <- cumsum(exdfs_fruit$ext.end)


exdfs_fruit$perc.ext.rand.cum<-100-(exdfs_fruit$ext.rand.cum/379*100)

exdfs_fruit$perc.ext.deghigh.cum<-100-(exdfs_fruit$ext.deghigh.cum/379*100)

exdfs_fruit$perc.ext.deglow.cum<-100-((exdfs_fruit$ext.deglow.cum/379)*100)

exdfs_fruit$perc.ext.end.cum<-100-((exdfs_fruit$ext.end.cum/379)*100)


exdfs2_fruit <- exdfs_fruit%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs3_fruit <- exdfs_fruit%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 
curve_plot_fruit <- ggplot(data= exdfs2_fruit, aes(x= perc.no, y=perc.ext.rand))+
  ylab("% of trees surviving")+
  xlab("% of lemurs extinct")+
  theme_classic()+
  geom_point(color="black")+
  ylim(c(85,100))+
  geom_point(aes(x= perc.no, y=perc.ext.end), color="#D55E00")+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh), color="#56B4E9")+
  geom_point(aes(x= perc.no, y=perc.ext.deglow), color="E69F00")+
  geom_smooth(color="black")+
  geom_smooth(aes(x= perc.no, y=perc.ext.end), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh), color="56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow), color="E69F00")




curve_plot2_fruit <- ggplot(data= exdfs3_fruit, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Trees With Interaction(s)")+
  xlab("% Lemurs Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.3)+
  geom_smooth(color="black")+
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))




# Calculate network level measures, connectance, compartments, nestedness
# The origional Network 
netres_fruit<-networklevel(bipart_frugivore,  index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                     ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "random", 
                     nrep = 1, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                     logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                     fcdist="euclidean", legacy=FALSE)
netres_fruit

mod_mut <- computeModules(bipart_frugivore)
mod_mut <- mod_mut@likelihood


```

```{r Post-Extinction Mutualistic Network - Lemur}

#Subgraph network so that it does not include EN or CR species


lem_fruit<-rep("lemur",43)
tree_fruit<-rep("tree",379)
type_fruit<-c(lem_fruit,tree_fruit)

names(type_fruit)<- net_frugivore %v% 'vertex.names'
length(type_fruit)

network::set.vertex.attribute(net_frugivore,"type",type_fruit)
network::get.vertex.attribute(net_frugivore,attrname="type")

subgraph_nonthreatened_fruit<-get.inducedSubgraph(net_frugivore,which(net_frugivore%v%"Threat"=="1"|net_frugivore%v%"Threat"=="3"|net_frugivore%v%"type"=="tree"))

plot(subgraph_nonthreatened_fruit, displaylabels = F)
network.vertex.names(subgraph_nonthreatened_fruit)
subgraph_nonthreatened_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_fruit,cmode="indegree")
summary(subgraph_nonthreatened_fruit%v%"degree")
subgraph_nonthreatened2_fruit<-get.inducedSubgraph(subgraph_nonthreatened_fruit,which(subgraph_nonthreatened_fruit%v%"degree">0))
plot(subgraph_nonthreatened2, displaylabels = F)

bipart_0s_nothreat_fruit <- as.matrix.network(subgraph_nonthreatened2_fruit)



##secondary extinction

# Scenario 1 
(ex_extinct_fruit <- second.extinct(bipart_0s_nothreat_fruit, participant="lower", method="random", nrep=16, 
                              details=F))
ex_extinct_fruit
summary(ex_extinct_fruit)
rob_ext_1_fruit<-robustness(ex_extinct_fruit)


# Scenario 2
(ex2_extinct_fruit <- second.extinct(bipart_0s_nothreat_fruit, participant="lower", method="degree", nrep=16, 
                               details=F))
ex2_extinct_fruit
summary(ex2_extinct_fruit)

rob_ext_2_fruit<-robustness(ex2_extinct_fruit)


# Scenario3 
net_threat_fruit<-network(bipart_0s_nothreat_fruit,bipartite=T,matrix.type="bipartite")
net_threat_fruit %v% "degree" <- sna::degree(net_threat_fruit,cmode="indegree")
degreedf2_fruit<-as.data.frame(net_threat_fruit%v%"degree")
degreedf2_fruit$node<-rownames(degreedf2_fruit)
degreedf2_fruit$name<-net_threat_fruit%v%"vertex.names"
dim(degreedf2_fruit)
dim(bipart_0s_nothreat_fruit)
degreedfhost2_fruit<-degreedf2_fruit[1:16,]
degreedfhost2_fruit<-sort(degreedfhost2_fruit)
as.numeric(degreedfhost2_fruit$node)

dim(degreedfhost2_fruit)
dim(bipart_0s_nothreat_fruit)
(ex3_extinct_fruit <- second.extinct(bipart_0s_nothreat_fruit, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost2_fruit$node), 
                       details=F))
ex3_extinct_fruit
summary(ex3_extinct_fruit)

rob_ext_3_fruit<-robustness(ex3_extinct_fruit)

#Scenario 4 
##order from first to last the species that are 1) most endangered and 2) smallest range
as.numeric(endangdflemur_fruit$node)
dim(bipart_0s_nothreat_fruit)
endangdflemur2_fruit<-endangdflemur_fruit[28:43,]
endangdflemur2_fruit<-endangdflemur2_fruit[order(-endangdflemur2_fruit$status,endangdflemur2_fruit$area),]
dim(endangdflemur2_fruit)
endangdflemur2_fruit$node <-as.numeric(endangdflemur2_fruit$node)
rownames(endangdflemur2_fruit) <- rep(1:16)
endangdflemur2_fruit$node <- rep(1:16)
(ex4_extinct_fruit <- second.extinct(bipart_0s_nothreat_fruit, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur2_fruit$node), 
                       details=F))
ex4_extinct_fruit
summary(ex4_extinct_fruit)
plot(ex4_extinct_fruit)
str(ex4_extinct_fruit)

rob_extinct_4_fruit<-robustness(ex4_extinct_fruit)



########connectance and other measures on the bipartite network
netres_extinct_fruit<-networklevel(bipart_0s_nothreat_fruit, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct_fruit 

as.data.frame(netres_extinct_fruit)

mod_mut_extinct <- computeModules(bipart_0s_nothreat_fruit)
mod_mut_extinct <- mod_mut_extinct@likelihood


```

```{r Null model Mutualistic Network - Lemur}

net2_frugivore<-net_frugivore

netres_random_fruit<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)

for(i in 1:100){
  set.seed(i)
  n<-43
  rand<-rbinom(n,1,0.6222222)
  summary(as.factor(rand))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net)[43:length(network.vertex.names(net_frugivore))])))
  
  net2_frugivore%v%"rand"<-rand
  summary(net2%v%"rand")
  
   subgraph_nonthreatened_rand_fruit<-get.inducedSubgraph(net2_frugivore,which(net2_frugivore%v%"rand"=="0"|net2_frugivore%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_fruit,cmode="indegree")
  subgraph_nonthreatened_rand2_fruit<-get.inducedSubgraph(subgraph_nonthreatened_rand_fruit,which(subgraph_nonthreatened_rand_fruit%v%"degree">0))
  
  bipart_0s_nothreat_rand_fruit<-as.matrix.network(subgraph_nonthreatened_rand2_fruit)
  dim(bipart_0s_nothreat_rand_fruit)
  
  (ex_rand_fruit <- second.extinct(bipart_0s_nothreat_rand_fruit, participant="lower", method="random", nrep=dim(bipart_0s_nothreat_rand_fruit)[1], 
                             details=F))
  ex_rand_fruit
  rob_rand1_fruit<-robustness(ex_rand_fruit)
  
  
  (ex2_rand_fruit <- second.extinct(bipart_0s_nothreat_rand_fruit, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_rand_fruit)[1], 
                              details=F))
  ex2_rand_fruit
  summary(ex2_rand_fruit)
  
  rob_rand2_fruit<-robustness(ex2_rand_fruit)
 
  
#Scenario 3 
degreedf3_fruit<-as.data.frame(subgraph_nonthreatened_rand2_fruit%v%"degree")
degreedf3_fruit$node<-rownames(degreedf3_fruit)
degreedf3_fruit$name<-subgraph_nonthreatened_rand2_fruit%v%"vertex.names"
degreedfhost3_fruit<-degreedf3_fruit[1:as.numeric(nrow(bipart_0s_nothreat_rand_fruit)[1]),]
degreedfhost3_fruit<-sort(degreedfhost3_fruit)
as.numeric(degreedfhost3_fruit$node)

(ex3_rand_fruit <- second.extinct(bipart_0s_nothreat_rand_fruit, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_fruit$node), 
                       details=F))
ex3_rand_fruit
summary(ex3_rand_fruit)

rob_rand_3_fruit<-robustness(ex3_rand_fruit)

#Scenario 4
dim(bipart_0s_nothreat_rand_fruit)
endangdflemur_fruit<-endangdflemur_fruit[order(-endangdflemur_fruit$status,endangdflemur_fruit$area),]
dim(endangdflemur_fruit)
endangdflemur_fruit$node <-as.numeric(endangdflemur_fruit$node)
dim(bipart_0s_nothreat_rand_fruit)
lemur_names <- as.data.frame(rownames(bipart_0s_nothreat_rand_fruit))
colnames(lemur_names) <- "name"
endangdflemur2_fruit <- left_join(lemur_names, endangdflemur_fruit)
rownames(endangdflemur2_fruit) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_fruit)[1]))
endangdflemur2_fruit$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_fruit)[1]))
(ex4_rand_fruit <- second.extinct(bipart_0s_nothreat_rand_fruit, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur2_fruit$node), 
                       details=F))
ex4_rand_fruit

rob_rand4_fruit<-robustness(ex4_rand_fruit)


  ###network level results
  netres_extinct_rand <-networklevel(bipart_0s_nothreat_rand_fruit, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
  netres_random_fruit[i,]<-cbind(as.data.frame(t(netres_extinct_rand)),rob_rand1_fruit ,rob_rand2_fruit, rob_rand_3_fruit, rob_rand4_fruit)
}

summary(netres_random_fruit)


min(netres_random_fruit$connectance)
max(netres_random_fruit$connectance)
median(netres_random_fruit$connectance)

min(netres_random_fruit$nest)
max(netres_random_fruit$nest)
median(netres_random_fruit$nest)

min(netres_random_fruit$robust1)
max(netres_random_fruit$robust1)
median(netres_random_fruit$robust1)

min(netres_random_fruit$robust2)
max(netres_random_fruit$robust2)
median(netres_random_fruit$robust2)

min(netres_random_fruit$robust3)
max(netres_random_fruit$robust3)
median(netres_random_fruit$robust3)

min(netres_random_fruit$robust4)
max(netres_random_fruit$robust4)
median(netres_random_fruit$robust4)


#compute p-values

p.con_mut <- prop(~connectance >= netres_fruit[1], data= netres_random_fruit)
p.con2_mut <- prop(~connectance <= netres_fruit[1], data= netres_random_fruit)  
p.con_ex_mut <- prop(~connectance >= netres_extinct_fruit[1], data= netres_random_fruit)
p.con_ex2_mut <- prop(~connectance <= netres_extinct_fruit[1], data= netres_random_fruit)  

p.nest_mut <- prop(~nest >= netres_fruit[3], data= netres_random_fruit)
p.nest2_mut <- prop(~nest <= netres_fruit[3], data= netres_random_fruit)  
p.nest_ex_mut <- prop(~nest >= netres_extinct_fruit[3], data= netres_random_fruit)
p.nest_ex2_mut <- prop(~nest <= netres_extinct_fruit[3], data= netres_random_fruit) 

p.rob1_mut <- prop(~robust1 >= rob1_fruit, data= netres_random_fruit)
p.rob12_mut <- prop(~robust1 <= rob1_fruit, data= netres_random_fruit)  
p.rob1_ex_mut <- prop(~robust1 >= rob_ext_1_fruit, data= netres_random_fruit)
p.rob1_ex2_mut <- prop(~robust1  <= rob_ext_1_fruit, data= netres_random_fruit) 

p.rob2_mut <- prop(~robust2 >= rob2_fruit, data= netres_random_fruit)
p.rob22_mut <- prop(~robust2 <= rob2_fruit, data= netres_random_fruit)  
p.rob2_ex_mut <- prop(~robust2 >= rob_ext_2_fruit, data= netres_random_fruit)
p.rob2_ex2_mut <- prop(~robust2  <= rob_ext_2_fruit, data= netres_random_fruit) 

p.rob3_mut <- prop(~robust3 >= rob3_fruit, data= netres_random_fruit)
p.rob32_mut <- prop(~robust3 <= rob3_fruit, data= netres_random_fruit)  
p.rob3_ex_mut <- prop(~robust3 >= rob_ext_3_fruit, data= netres_random_fruit)
p.rob3_ex2_mut <- prop(~robust3  <= rob_ext_3_fruit, data= netres_random_fruit) 

p.rob4_mut <- prop(~robust4 >= rob4_fruit, data= netres_random_fruit)
p.rob42_mut <- prop(~robust4 <= rob4_fruit, data= netres_random_fruit)  
p.rob4_ex_mut <- prop(~robust4 >= rob_extinct_4_fruit, data= netres_random_fruit)
p.rob4_ex2_mut <- prop(~robust4  <= rob_extinct_4_fruit, data= netres_random_fruit) 


netres_random2 <- netres_random%>%
  pivot_longer(cols = c(5:8), values_to= "Robustness", names_to ="Scenario")%>%
   mutate(Scenario = factor(Scenario, levels=c("robust5", "robust2", "robust3", "robust4")))

ggplot(data= netres_random2, aes(y=Robustness, x= Scenario))+
  geom_boxplot()+
  theme_classic()+
  scale_x_discrete(labels=c("robust5" = "Random", "robust2" = "Degree High-Low",
                              "robust3" = "Degree Low-High", "robust4" = "Extinction Likelihood"))

summary(aov(netres_random2$Robustness~netres_random2$Scenario))
TukeyHSD(aov(netres_random2$Robustness~netres_random2$Scenario))

```

```{r Modularity Null model Mutualistic Network - Lemur}


##try with better modularity calculations

net2_frugivore<-net_frugivore

mod_random_fruit<-data.frame(mod = NA)

for(i in 1:100){
  set.seed(i)
  n<-43
  rand<-rbinom(n,1,0.6222222)
  summary(as.factor(rand))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net)[43:length(network.vertex.names(net_frugivore))])))
  
  net2_frugivore%v%"rand"<-rand
  summary(net2%v%"rand")
  
   subgraph_nonthreatened_rand_fruit<-get.inducedSubgraph(net2_frugivore,which(net2_frugivore%v%"rand"=="0"|net2_frugivore%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_fruit,cmode="indegree")
  subgraph_nonthreatened_rand2_fruit<-get.inducedSubgraph(subgraph_nonthreatened_rand_fruit,which(subgraph_nonthreatened_rand_fruit%v%"degree">0))
  
  bipart_0s_nothreat_rand_fruit<-as.matrix.network(subgraph_nonthreatened_rand2_fruit)
  dim(bipart_0s_nothreat_rand_fruit)

mod_mut_random <- computeModules(bipart_0s_nothreat_rand_fruit)
mod_mut_random <- mod_mut_random@likelihood

  mod_random_fruit[i,]<-cbind(mod_mut_random)
}
mod_random_fruit
write.csv(mod_random_fruit, "mod_random_fruit.csv")
summary(mod_random_fruit)




min(mod_random_fruit)
max(mod_random_fruit)
median(mod_random_fruit$mod)

p.value_mod_mt <- prop(~mod >= mod_mut, data= mod_random_fruit)
p.value_mod_m2t <- prop(~mod <= mod_mut, data= mod_random_fruit)
p.value_mod_mt_ex <- prop(~mod >= mod_mut_extinct, data= mod_random_fruit)
p.value_mod_mt_ex2 <- prop(~mod <= mod_mut_extinct, data= mod_random_fruit)


```

#Mutualistic Tree Extinctions

```{r Original Mutualistic Network - Tree}
#secondary extinction

bipart3_frugivore <- t(bipart_frugivore)
bipart3_frugivore[is.na(bipart3_frugivore)] <- 0
dim(bipart3_frugivore)

# Scienario 1: Random 
(ex_t_fruit <- second.extinct(bipart3_frugivore, participant="lower", method="random", nrep=379, 
                      details=F))
ex_t_fruit
summary(ex_t_fruit)
plot(ex_t_fruit)
rob1_t_fruit<-robustness(ex_t_fruit)

exdf_t_fruit<-as.data.frame(ex_t_fruit[1:379,])
plot(exdf_t_fruit$ext.higher~exdf_t_fruit$no)


# Scenario 2: removal of trees from highest to lowest degree
(ex2_t_fruit <- second.extinct(bipart3_frugivore, participant="lower", method="degree", nrep=379, 
                       details=F))
ex2_t_fruit
summary(ex2_t_fruit)

ex2df_t_fruit<-as.data.frame(ex2_t_fruit[1:379,])
plot(ex2df_t_fruit$ext.higher~ex2df_t_fruit$no)

rob2_t_fruit<-robustness(ex2_t_fruit)
dim(bipart3_frugivore)

#Scenario 3: remove lemurs from lowest to highest degree
net_frugivore %v% "degree" <- sna::degree(net_frugivore,cmode="indegree")
degreedf2_t_fruit<-as.data.frame(net_frugivore%v%"degree")
degreedf2_t_fruit$node<-rownames(degreedf2_t_fruit)
degreedf2_t_fruit$name<-net_frugivore%v%"vertex.names"
degreedf2_t_fruit$node <- as.numeric(degreedf2_t_fruit$node)-43
degreedf2_t_fruit$node <- sort(degreedf2_t_fruit$node)

fruit_trees <- as.data.frame(rownames(bipart3_frugivore))
colnames(fruit_trees) <- "name"
degreedf2_t_fruit2 <- merge(degreedf2_t_fruit,fruit_trees, by="name" )
dim(degreedf2_t_fruit2)
degreedf2_t_fruit2<-sort(degreedf2_t_fruit2)
as.numeric(degreedf2_t_fruit2$node)
degreedf2_t_fruit2$`net_frugivore %v% "degree"` <- sort(as.numeric(degreedf2_t_fruit2$`net_frugivore %v% "degree"`))

dim(bipart3_frugivore)
dim(degreedf2_t_fruit2)

(ex3_t_fruit <- second.extinct(bipart3_frugivore, participant="lower", method="external",ext.row=as.numeric(degreedf2_t_fruit2$node), 
                       details=F))

ex3df_t_fruit<-as.data.frame(ex3_t_fruit[1:379,])

rob3_t_fruit<-robustness(ex3_t_fruit)

#Scenario 4: Remove lemurs according to extinction likelihood 

vertextraits_frugivore$mIUCN<- relevel(factor(vertextraits_frugivore$mIUCN),ref = "1")
Threat_t_fruit<-as.character(vertextraits_frugivore$mIUCN)
summary(Threat_t_fruit)
length(Threat_t_fruit)
names(Threat_t_fruit)<-vertextraits_frugivore$species
Threat_t_fruit<-Threat_t_fruit[ net_frugivore %v% 'vertex.names' ]
network::set.vertex.attribute(net_frugivore,"Threat_t_fruit",Threat_t_fruit)


endangdf_t_fruit<-data.frame( species=net_frugivore%v%"vertex.names",
                     Threat=net_frugivore%v%"Threat_t_fruit")
dim(bipart3_frugivore)
fruit_trees <- as.data.frame(rownames(bipart3_frugivore))
colnames(fruit_trees) <- "species"
endangdf_t_fruit$status <endangdf_t_fruit$Threat

Threat_traits2 <- merge(endangdf_t_fruit, fruit_trees, by="species")
dim(Threat_traits2)
Threat_traits2$status <- Threat_traits2$Threat

Threat_traits2$status <- as.numeric(Threat_traits2$status)
dim(Threat_traits2)

##order from first to last the species that are most endangered
Threat_traits2<-Threat_traits2[order(-Threat_traits2$status),]
Threat_traits2$node <- rep(1:379)
dim(Threat_traits2)
dim(bipart3_frugivore)

(ex4_t_fruit <- second.extinct(bipart3_frugivore, participant="lower", method="external", ext.row=as.numeric(Threat_traits2$node), 
                       details=F))
ex4_t_fruit
summary(ex4_t_fruit)

rob4_t_fruit <- robustness(ex4_t_fruit)

ex4df_t_fruit<-as.data.frame(ex4_t[1:379,])
plot(ex4df_t_fruit$ext.higher~ex4df_t_fruit$no)

#combine the different extinction scenarios
exdfs_t_fruit<-cbind(exdf_t_fruit,ex2df_t_fruit,ex3df_t_fruit,ex4df_t_fruit)
colnames(exdfs_t_fruit)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
summary(exdfs_t_fruit)
##convert to %
exdfs_t_fruit$perc.no<-exdfs_t_fruit$no/379*100
exdfs_t_fruit$perc.ext.rand<-100-(exdfs_t_fruit$ext.rand/43*100)
exdfs_t_fruit$perc.ext.deghigh<-100-(exdfs_t_fruit$ext.deghigh/43*100)
exdfs_t_fruit$perc.ext.deglow<-100-(exdfs_t_fruit$ext.deglow/43*100)
exdfs_t_fruit$perc.ext.end<-100-(exdfs_t_fruit$ext.end/43*100)

exdfs_t_fruit$ext.rand.cum <- cumsum(exdfs_t_fruit$ext.rand)
exdfs_t_fruit$ext.deghigh.cum <- cumsum(exdfs_t_fruit$ext.deghigh)
exdfs_t_fruit$ext.deglow.cum <- cumsum(exdfs_t_fruit$ext.deglow)
exdfs_t_fruit$ext.end.cum <- cumsum(exdfs_t_fruit$ext.end)

exdfs_t_fruit$perc.ext.rand.cum<-100-(exdfs_t_fruit$ext.rand.cum/43*100)
exdfs_t_fruit$perc.ext.deghigh.cum<-100-(exdfs_t_fruit$ext.deghigh.cum/43*100)
exdfs_t_fruit$perc.ext.deglow.cum<-100-((exdfs_t_fruit$ext.deglow.cum/43)*100)
exdfs_t_fruit$perc.ext.end.cum<-100-((exdfs_t_fruit$ext.end.cum/43)*100)

exdfs2_t_fruit <- exdfs_t_fruit%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs2_t2_fruit <- exdfs_t_fruit%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 
curve_plot_t_fruit <- ggplot(data= exdfs2_t_fruit, aes(x= perc.no, y=perc.ext.rand))+
  ylab("% of lemurs surviving")+
  xlab("% of trees extinct")+
  theme_classic()+
  geom_point(color="black")+
  ylim(c(85,100))+
  geom_point(aes(x= perc.no, y=perc.ext.end), color="red")+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh), color="purple")+
  geom_point(aes(x= perc.no, y=perc.ext.deglow), color="orange")

#plot all of the extinction scenarios 
curve_plot_t2_fruit <- ggplot(data= exdfs2_t2_fruit, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Lemurs With Interaction(s)")+
  xlab("% Trees Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.1)+
  geom_smooth(color="black")+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.1)+  
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))

curve_plots_fruit <- ggarrange(curve_plot2_fruit, curve_plot_t2_fruit, labels = c("A", "B"))

```

```{r Post_Extinction Mutualistic Network - Tree}
iucn_fruit<-iucn[ net_frugivore %v% 'vertex.names' ]
network::set.vertex.attribute(net_frugivore,"iucn",iucn_fruit)
network::get.vertex.attribute(net_frugivore,"iucn")

#Subgraph network so that it does not include EN or CR species
subgraph_reduced_iucn_fruit<-get.inducedSubgraph(net_frugivore,which(!is.na(net_frugivore%v%"iucn")|net_frugivore%v%"type"=="lemur"))
subgraph_nonthreatened_t_fruit<-get.inducedSubgraph(subgraph_reduced_iucn_fruit,which(subgraph_reduced_iucn_fruit%v%"iucn"=="1"|subgraph_reduced_iucn_fruit%v%"iucn"=="2"|subgraph_reduced_iucn_fruit%v%"iucn"=="3"|subgraph_reduced_iucn_fruit%v%"type"=="lemur"))
network.vertex.names(subgraph_nonthreatened_t_fruit)
subgraph_nonthreatened_t_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_t_fruit,cmode="indegree")
summary(subgraph_nonthreatened_t_fruit%v%"degree")
subgraph_nonthreatened2_t_fruit<-get.inducedSubgraph(subgraph_nonthreatened_t_fruit,which(subgraph_nonthreatened_t_fruit%v%"degree">0))


bipart_0s_nothreat_t_fruit<-as.matrix.network(subgraph_nonthreatened2_t_fruit)
bipart_0s_nothreat_t_fruit <- t(bipart_0s_nothreat_t_fruit)
dim(bipart_0s_nothreat_t_fruit)



##secondary extinction

# Scenario 1 
(ex_extinct_t_fruit <- second.extinct(bipart_0s_nothreat_t_fruit, participant="lower", method="random", nrep=230, 
                              details=F))
ex_extinct_t_fruit
summary(ex_extinct_t_fruit)
rob_ext_1_t_fruit<-robustness(ex_extinct_t_fruit)


# Scenario 2
(ex2_extinct_t_fruit <- second.extinct(bipart_0s_nothreat_t_fruit, participant="lower", method="degree", nrep=230, 
                               details=F))
ex2_extinct_t_fruit
summary(ex2_extinct_t_fruit)

rob_ext_2_t_fruit<-robustness(ex2_extinct_t_fruit)


# Scenario3
net_threat_t_fruit<-network(bipart_0s_nothreat_t_fruit,bipartite=T,matrix.type="bipartite")
dim(bipart_0s_nothreat_t_fruit)
net_threat_t_fruit %v% "degree" <- sna::degree(net_threat_t_fruit,cmode="indegree")
degreedf2_t_fruit<-as.data.frame(net_threat_t_fruit%v%"degree")
degreedf2_t_fruit$node<-rownames(degreedf2_t_fruit)
degreedf2_t_fruit$name<-net_threat_t_fruit%v%"vertex.names"
degreedf2_t_fruit$node <- as.numeric(degreedf2_t_fruit$node)
degreedf2_t_fruit$node <- sort(degreedf2_t_fruit$node)
dim(bipart_0s_nothreat_t_fruit)

fruit_trees_nothreat <- as.data.frame(rownames(bipart_0s_nothreat_t_fruit))
colnames(fruit_trees_nothreat) <- "name"
degreedf2_t_fruit2 <- merge(degreedf2_t_fruit,fruit_trees_nothreat, by="name" )
dim(degreedf2_t_fruit2)
degreedf2_t_fruit2<-sort(degreedf2_t_fruit2)
as.numeric(degreedf2_t_fruit2$node)
degreedf2_t_fruit2$`net_threat_t_fruit %v% "degree"` <- sort(as.numeric(degreedf2_t_fruit2$`net_threat_t_fruit %v% "degree"`))

dim(degreedf2_t_fruit2)
dim(bipart_0s_nothreat_t_fruit)

(ex3_extinct_t_fruit <- second.extinct(bipart_0s_nothreat_t_fruit, participant="lower", method="external",ext.row=as.numeric(degreedf2_t_fruit2$node), 
                       details=F))
ex3_extinct_t_fruit
summary(ex3_extinct_t_fruit)

rob_ext_3_t_fruit <- robustness(ex3_extinct_t_fruit)


#Scenario 4 
##order from first to last the species that are most endangered
dim(bipart_0s_nothreat_t_fruit)
dim(fruit_trees_nothreat)
dim(endangdf_t)
endangdftree2 <- merge(endangdf_t,fruit_trees_nothreat, by="name" )
endangdftree2$status<- as.numeric(endangdftree2$status)
endangdftree2<-endangdftree2[order(-endangdftree2$status),]
dim(endangdftree2)
rownames(endangdftree2) <- rep(1:230)
endangdftree2$node <- rep(1:230)
(ex4_extinct_t_fruit <- second.extinct(bipart_0s_nothreat_t_fruit, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2$node), 
                       details=F))
ex4_extinct_t_fruit
summary(ex4_extinct_t_fruit)
plot(ex4_extinct_t_fruit)
str(ex4_extinct_t_fruit)

rob_extinct_4_t_fruit<-robustness(ex4_extinct_t_fruit)



########connectance and other measures on the bipartite network
netres_extinct_t_fruit<-networklevel(bipart_0s_nothreat_t_fruit, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct_t_fruit 


g_mut_extinct_t <- igraph::graph.incidence(bipart_0s_nothreat_t_fruit)
wtc_mut_extinct_t <- cluster_walktrap(g_mut_extinct_t)
mod_mut_extinct_t <- modularity(wtc_mut_extinct_t)

mod_mut_extinct_t <- computeModules(bipart_0s_nothreat_t_fruit)
mod_mut_extinct_t <- mod_mut_extinct_t@likelihood


```

```{r Null model Mutualistic Network - Tree}

net2_frugivore<-net_frugivore

netres_random_phy_t_fruit<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)

for(i in 1:100){
  set.seed(i)
   n <- 379
  rand_t<-rbinom(n,1, 0.08443272)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",45), rand_t)
  
  net2_frugivore%v%"rand_t"<-rand_t
  summary(net2_frugivore%v%"rand_t")
  
   subgraph_nonthreatened_rand_t_fruit<-get.inducedSubgraph(net2_frugivore,which(net2_frugivore%v%"rand_t"=="0"|net2_frugivore%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t_fruit,cmode="indegree")
  subgraph_nonthreatened_rand2_t_fruit<-get.inducedSubgraph(subgraph_nonthreatened_rand_t_fruit,which(subgraph_nonthreatened_rand_t_fruit%v%"degree">0))
  
  bipart_0s_nothreat_rand_t_fruit<-as.matrix.network(subgraph_nonthreatened_rand2_t_fruit)
  dim(bipart_0s_nothreat_rand_t_fruit)
  
  bipart_0s_nothreat_rand_t2_fruit <- t(bipart_0s_nothreat_rand_t_fruit)
bipart_0s_nothreat_rand_t2_fruit[is.na(bipart_0s_nothreat_rand_t2_fruit)] <- 0
dim(bipart_0s_nothreat_rand_t2_fruit)

  
  
  (ex_rand_t_fruit <- second.extinct(bipart_0s_nothreat_rand_t2_fruit, participant="lower", method="random", nrep=as.numeric(nrow(bipart_0s_nothreat_rand_t2_fruit)), 
                             details=F))

  rob_rand1_t_fruit<-robustness(ex_rand_t_fruit) 
  
  (ex2_rand_t_fruit<- second.extinct(bipart_0s_nothreat_rand_t2_fruit, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_t_fruit)[1], 
                              details=F))

  rob_rand2_t_fruit<-robustness(ex2_rand_t_fruit) ##0.3179649
 
#Scenario 3 
as.numeric(ncol(bipart_0s_nothreat_rand_t2_fruit))
degreedf3_t_fruit<-as.data.frame(subgraph_nonthreatened_rand2_t_fruit%v%"degree")
degreedf3_t_fruit$node<-rownames(degreedf3_t_fruit)
degreedf3_t_fruit$name<-subgraph_nonthreatened_rand2_t_fruit%v%"vertex.names"
degreedfhost3_t_fruit<-degreedf3_t_fruit[-c(1:as.numeric(ncol(bipart_0s_nothreat_rand_t2_fruit))),]
degreedfhost3_t_fruit<-sort(degreedfhost3_t_fruit)
degreedfhost3_t_fruit$node2 <- as.numeric(degreedfhost3_t_fruit$node)-as.numeric(ncol(bipart_0s_nothreat_rand_t2_fruit))



(ex3_extinct_rand_t_fruit <- second.extinct(bipart_0s_nothreat_rand_t2_fruit, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_t_fruit$node2), 
                       details=F))

rob_rand3_t_fruit<-robustness(ex3_extinct_rand_t_fruit) #0.9732548 

#Scenario 4 
##order from first to last the species that are most endangered
endangdf_t_fruit<-endangdf_t_fruit[order(-as.numeric(endangdf_t_fruit$status)),]
tree_names_fruit <- as.data.frame(rownames(bipart_0s_nothreat_rand_t2_fruit))
colnames(tree_names_fruit) <- "name"
 endangdf_t_fruit$name <-  endangdf_t_fruit$species
endangdftree2_fruit <- left_join(tree_names_fruit, endangdf_t_fruit)
rownames(endangdftree2_fruit) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2_fruit)[1]))
endangdftree2_fruit$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2_fruit)[1]))

(ex4_rand_t_fruit <- second.extinct(bipart_0s_nothreat_rand_t2_fruit, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2_fruit$node), 
                       details=F))
rob_rand4_t_fruit<-robustness(ex4_rand_t_fruit)


  
  ###network level results
  netres_extinct_rand_t_fruit <-networklevel(bipart_0s_nothreat_rand_t2_fruit, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
  netres_random_phy_t_fruit[i,]<-cbind(as.data.frame(t(netres_extinct_rand_t_fruit)),rob_rand1_t_fruit, rob_rand2_t_fruit, rob_rand3_t_fruit, rob_rand4_t_fruit)
}

summary(netres_random_phy_t_fruit)

#calculate p-values
p.value <- prop(~connectance >= netres_fruit[1], data= netres_random_phy_t_fruit)
p.value <- prop(~connectance <= netres_fruit[1], data= netres_random_phy_t_fruit)  
p.value <- prop(~connectance >= netres_extinct_t_fruit[1], data= netres_random_phy_t_fruit)
p.value <- prop(~connectance <= netres_extinct_t_fruit[1], data= netres_random_phy_t_fruit)  

p.value <- prop(~comps >= netres_fruit[2], data= netres_random_phy_t_fruit)
p.value <- prop(~comps <= netres_fruit[2], data= netres_random_phy_t_fruit)  
p.value <- prop(~comps >= netres_extinct_t_fruit[2], data= netres_random_phy_t_fruit)
p.value <- prop(~comps <= netres_extinct_t_fruit[2], data= netres_random_phy_t_fruit)  

p.value <- prop(~nest >= netres_fruit[3], data= netres_random_phy_t_fruit)
p.value <- prop(~nest  <= netres_fruit[3], data= netres_random_phy_t_fruit)  
p.value <- prop(~nest  >= netres_extinct_t_fruit[3], data= netres_random_phy_t_fruit)
p.value <- prop(~nest  <= netres_extinct_t_fruit[3], data= netres_random_phy_t_fruit) 

p.value <- prop(~robust1 >= rob1_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust1  <= rob1_t_fruit, data= netres_random_phy_t_fruit)  
p.value <- prop(~robust1  >= rob_ext_1_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust1  <= rob_ext_1_t_fruit, data= netres_random_phy_t_fruit) 

p.value <- prop(~robust2 >= rob2_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust2  <= rob2_t_fruit, data= netres_random_phy_t_fruit)  
p.value <- prop(~robust2  >= rob_ext_2_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust2  <= rob_ext_2_t_fruit, data= netres_random_phy_t_fruit) 

p.value <- prop(~robust3 >= rob3_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust3  <= rob3_t_fruit, data= netres_random_phy_t_fruit)  
p.value <- prop(~robust3  >= rob_ext_3_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust3  <= rob_ext_3_t_fruit, data= netres_random_phy_t_fruit) 

p.value <- prop(~robust4 >= rob4_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust4  <= rob4_t_fruit, data= netres_random_phy_t_fruit)  
p.value <- prop(~robust4  >= rob_extinct_4_t_fruit, data= netres_random_phy_t_fruit)
p.value <- prop(~robust4  <= rob_extinct_4_t_fruit, data= netres_random_phy_t_fruit) 

```

```{r Modularity Null Model Mutualistic Network - Tree}
net2_frugivore<-net_frugivore

mod_random_phy_t_fruit<-data.frame(mod=NA)

for(i in 1:100){
  set.seed(i)
   n <- 379
  rand_t<-rbinom(n,1, 0.08443272)### the proportion of lemurs that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",45), rand_t)
  
  net2_frugivore%v%"rand_t"<-rand_t
  summary(net2_frugivore%v%"rand_t")
  
   subgraph_nonthreatened_rand_t_fruit<-get.inducedSubgraph(net2_frugivore,which(net2_frugivore%v%"rand_t"=="0"|net2_frugivore%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t_fruit%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t_fruit,cmode="indegree")
  subgraph_nonthreatened_rand2_t_fruit<-get.inducedSubgraph(subgraph_nonthreatened_rand_t_fruit,which(subgraph_nonthreatened_rand_t_fruit%v%"degree">0))
  
  bipart_0s_nothreat_rand_t_fruit<-as.matrix.network(subgraph_nonthreatened_rand2_t_fruit)
  dim(bipart_0s_nothreat_rand_t_fruit)
  
  bipart_0s_nothreat_rand_t2_fruit <- t(bipart_0s_nothreat_rand_t_fruit)
bipart_0s_nothreat_rand_t2_fruit[is.na(bipart_0s_nothreat_rand_t2_fruit)] <- 0
dim(bipart_0s_nothreat_rand_t2_fruit)


mod_mut_random_t <- computeModules(bipart_0s_nothreat_rand_t2_fruit)
mod_mut_random_t <- mod_mut_random_t@likelihood

mod_random_phy_t_fruit[i,]<-cbind(mod_mut_random_t)

}
mod_random_phy_t_fruit
write.csv(mod_random_phy_t_fruit, "mod_random_phy_t_fruit.csv")
summary(mod_random_phy_t_fruit)



min(mod_random_phy_t_fruit)
max(mod_random_phy_t_fruit)
median(mod_random_phy_t_fruit$mod)

p.value_mod_mt_t <- prop(~mod >= mod_mut, data= mod_random_phy_t_fruit)
p.value_mod_m2t_t <- prop(~mod <= mod_mut, data= mod_random_phy_t_fruit)
p.value_mod_mt_ex_t <- prop(~mod >= mod_mut_extinct_t, data= mod_random_phy_t_fruit)
p.value_mod_mt_ex2_t <- prop(~mod <= mod_mut_extinct_t, data= mod_random_phy_t_fruit)



```

#Antagonistic Lemur Extinctions

```{r Original Antagonistic Network - Lemur}
#secondary extinction
bipart_antagonistic <- bipart_antagonistic2
bipart_antagonistic<- bipart_antagonistic[-24,]
antagonistic_species <- rownames(bipart_antagonistic)
antagonistic_species <- as.data.frame(antagonistic_species)
colnames(antagonistic_species)<- "species"

# Scienario 1: Random 
(ex_ant <- second.extinct(bipart_antagonistic, participant="lower", method="random", nrep=50, 
                      details=F))
ex_ant 
rob1_ant <-robustness(ex_ant)

exdf_ant<-as.data.frame(ex_ant[1:50,])

# Scenario 2: removal of lemurs from highest to lowest degree
(ex2_ant <- second.extinct(bipart_antagonistic, participant="lower", method="degree", nrep=50, 
                       details=F))
ex2_ant

ex2df_ant<-as.data.frame(ex2_ant[1:50,])

rob2_ant<-robustness(ex2_ant)


#Scenario 3: remove lemurs from lowest to highest degree
net_antagonistic <-network(bipart_antagonistic,bipartite=T,matrix.type="bipartite")

net_antagonistic %v% "degree" <- sna::degree(net_antagonistic,cmode="indegree")

degreedf_ant<-as.data.frame(net_antagonistic%v%"degree")
degreedf_ant$node<-rownames(degreedf_ant)
degreedf_ant$name<-net_antagonistic%v%"vertex.names"
degreedfhost_ant<-degreedf_ant[1:50,]
degreedfhost_ant<-sort(degreedfhost_ant)
as.numeric(degreedfhost_ant$node)

(ex3_ant <- second.extinct(bipart_antagonistic, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost_ant$node), 
                       details=F))

ex3df_ant<-as.data.frame(ex3_ant[1:50,])

rob3_ant<-robustness(ex3_ant)

#Scenario 4: Remove lemurs according to extinction likelihood 

endangdf_new <- endangdf
endangdf_new$species <- endangdf_new$name

endangdf_ant <- semi_join(endangdf_new, antagonistic_species, by="species")

endangdflemur_ant <- endangdf_ant[1:50,]
endangdflemur_ant$status <- as.numeric(endangdflemur_ant$Threat)

##order from first to last the species that are 1) most endangered and 2) smallest range
endangdflemur_ant<-endangdflemur_ant[order(-endangdflemur_ant$status,endangdflemur_ant$area),]

endangdflemur_ant$node <- 1:50

(ex4_ant <- second.extinct(bipart_antagonistic, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur_ant$node), 
                       details=F))

rob4_ant<-robustness(ex4_ant)

ex4df_ant<-as.data.frame(ex4_ant[1:50,])

#combine the different extinction scenarios
exdfs_ant<-cbind(exdf_ant,ex2df_ant,ex3df_ant,ex4df_ant)
colnames(exdfs_ant)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
##convert to %
exdfs_ant$perc.no<-exdfs_ant$no/50*100
exdfs_ant$perc.ext.rand<-100-(exdfs_ant$ext.rand/451*100)
exdfs_ant$perc.ext.deghigh<-100-(exdfs_ant$ext.deghigh/451*100)
exdfs_ant$perc.ext.deglow<-100-((exdfs_ant$ext.deglow/451)*100)
exdfs_ant$perc.ext.end<-100-((exdfs_ant$ext.end/451)*100)

exdfs_ant$ext.rand.cum <- cumsum(exdfs_ant$ext.rand)
exdfs_ant$ext.deghigh.cum <- cumsum(exdfs_ant$ext.deghigh)
exdfs_ant$ext.deglow.cum <- cumsum(exdfs_ant$ext.deglow)
exdfs_ant$ext.end.cum <- cumsum(exdfs_ant$ext.end)

exdfs_ant$perc.ext.rand.cum<-100-(exdfs_ant$ext.rand.cum/451*100)
exdfs_ant$perc.ext.deghigh.cum<-100-(exdfs_ant$ext.deghigh.cum/451*100)
exdfs_ant$perc.ext.deglow.cum<-100-((exdfs_ant$ext.deglow.cum/451)*100)
exdfs_ant$perc.ext.end.cum<-100-((exdfs_ant$ext.end.cum/451)*100)


exdfs2_ant <- exdfs_ant%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs3_ant <- exdfs_ant%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 

curve_plot2_ant<- ggplot(data= exdfs3_ant, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Trees with Interaction(s)")+
  xlab("% Lemurs Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.3)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.3)+
  geom_smooth(color="black")+
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))




# Calculate network level measures, connectance, compartments, nestedness
# The origional Network 
netres_ant<-networklevel(bipart_antagonistic,  index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                     ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "random", 
                     nrep = 1, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                     logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                     fcdist="euclidean", legacy=FALSE)
netres_ant

mod_ant <- computeModules(bipart_antagonistic)
mod_ant <- mod_ant@likelihood

```

```{r Post-Extinction Antagonistic Network - Lemur}

#Subgraph network so that it does not include EN or CR species
Threat_ant <- endangdflemur_ant$Threat
names(Threat_ant)<-endangdflemur_ant$species
length(Threat_ant)
Threat_ant<-Threat_ant[ net_antagonistic %v% 'vertex.names' ]
network::set.vertex.attribute(net_antagonistic,"Threat",Threat_ant)


lem_ant<-rep("lemur",50)
tree_ant<-rep("tree",451)
type_ant<-c(lem_ant,tree_ant)

names(type_ant) <- net_antagonistic %v% 'vertex.names'
length(type_ant)

network::set.vertex.attribute(net_antagonistic,"type",type_ant)
network::get.vertex.attribute(net_antagonistic,attrname="type")

network::set.vertex.attribute(net_antagonistic,"Threat",Threat_ant)
network::get.vertex.attribute(net_antagonistic,attrname="Threat")


subgraph_nonthreatened_ant<-get.inducedSubgraph(net_antagonistic,which(net_antagonistic%v%"Threat"=="1"|net_antagonistic%v%"Threat"=="3"|net_antagonistic%v%"type"=="tree"))
plot(subgraph_nonthreatened_ant, displaylabels = F)
network.vertex.names(subgraph_nonthreatened_ant)
subgraph_nonthreatened_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_ant,cmode="indegree")
summary(subgraph_nonthreatened_ant%v%"degree")
subgraph_nonthreatened2_ant<-get.inducedSubgraph(subgraph_nonthreatened_ant,which(subgraph_nonthreatened_ant%v%"degree">0))
plot(subgraph_nonthreatened2, displaylabels = F)

bipart_0s_nothreat_ant <- as.matrix.network(subgraph_nonthreatened2_ant)


##secondary extinction

# Scenario 1 
(ex_extinct_ant <- second.extinct(bipart_0s_nothreat_ant, participant="lower", method="random", nrep=19, 
                              details=F))

rob_ext_1_ant<-robustness(ex_extinct_ant)


# Scenario 2
(ex2_extinct_ant <- second.extinct(bipart_0s_nothreat_ant, participant="lower", method="degree", nrep=19, 
                               details=F))

rob_ext_2_ant<-robustness(ex2_extinct_ant)


# Scenario3 
net_threat_ant<-network(bipart_0s_nothreat_ant ,bipartite=T,matrix.type="bipartite")
net_threat_ant %v% "degree" <- sna::degree(net_threat_ant,cmode="indegree")
degreedf2_ant<-as.data.frame(net_threat_ant%v%"degree")
degreedf2_ant$node<-rownames(degreedf2_ant)
degreedf2_ant$name<-net_threat_ant%v%"vertex.names"
dim(degreedf2_ant)
dim(bipart_0s_nothreat_ant)
degreedfhost2_ant<-degreedf2_ant[1:19,]
degreedfhost2_ant<-sort(degreedfhost2_ant)
as.numeric(degreedfhost2_ant$node)

dim(degreedfhost2_ant)
dim(bipart_0s_nothreat_ant)
(ex3_extinct_ant <- second.extinct(bipart_0s_nothreat_ant, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost2_ant$node), 
                       details=F))
rob_ext_3_ant<-robustness(ex3_extinct_ant) 

#Scenario 4 
##order from first to last the species that are 1) most endangered and 2) smallest range
endangdflemur2_ant <- endangdflemur_ant
endangdflemur2_ant<-endangdflemur2_ant[order(-endangdflemur2_ant$status,endangdflemur2_ant$area),]
endangdflemur2_ant<-endangdflemur_ant[32:50,]
dim(endangdflemur2_ant)
endangdflemur2_ant$node <-as.numeric(endangdflemur2_ant$node)
rownames(endangdflemur2_ant) <- rep(1:19)
endangdflemur2_ant$node <- rep(1:19)
(ex4_extinct_ant<- second.extinct(bipart_0s_nothreat_ant, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur2_ant$node), 
                       details=F))

rob_extinct_4_ant <- robustness(ex4_extinct_ant)



########connectance and other measures on the bipartite network
netres_extinct_ant<-networklevel(bipart_0s_nothreat_ant, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct_ant 

as.data.frame(netres_extinct_ant)

mod_ant_extinct <- computeModules(bipart_0s_nothreat_ant)
mod_ant_extinct <- mod_ant_extinct@likelihood

```

```{r Null model Antagonistic Network - Lemur}

net2_antagontistic<-net_antagonistic

netres_random_ant<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)


for(i in 1:100){
  set.seed(i)
  n<-50
  rand<-rbinom(n,1,0.62)
  summary(as.factor(rand))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net_antagonistic)[50:length(network.vertex.names(net_antagonistic))])))
  
  net2_antagontistic%v%"rand"<-rand
  summary(net2_antagontistic%v%"rand")
  
   subgraph_nonthreatened_rand_ant<-get.inducedSubgraph(net2_antagontistic,which(net2_antagontistic%v%"rand"=="0"|net2_antagontistic%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_ant,cmode="indegree")
  subgraph_nonthreatened_rand2_ant<-get.inducedSubgraph(subgraph_nonthreatened_rand_ant,which(subgraph_nonthreatened_rand_ant%v%"degree">0))
  
  bipart_0s_nothreat_rand_ant<-as.matrix.network(subgraph_nonthreatened_rand2_ant)
  dim(bipart_0s_nothreat_rand_ant)
  
  (ex_rand_ant<- second.extinct(bipart_0s_nothreat_rand_ant, participant="lower", method="random", nrep=dim(bipart_0s_nothreat_rand_ant)[1], 
                             details=F))
  rob_rand1_ant<-robustness(ex_rand_ant)
  
  
  (ex2_rand_ant <- second.extinct(bipart_0s_nothreat_rand_ant, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_rand_ant)[1], 
                              details=F))
  
  rob_rand2_ant<-robustness(ex2_rand_ant) 
 
  
#Scenario 3 
degreedf3_ant<-as.data.frame(subgraph_nonthreatened_rand2_ant%v%"degree")
degreedf3_ant$node<-rownames(degreedf3_ant)
degreedf3_ant$name<-subgraph_nonthreatened_rand2_ant%v%"vertex.names"
degreedfhost3_ant<-degreedf3_ant[1:as.numeric(nrow(bipart_0s_nothreat_rand_ant)[1]),]
degreedfhost3_ant<-sort(degreedfhost3_ant)
as.numeric(degreedfhost3_ant$node)

(ex3_rand_ant<- second.extinct(bipart_0s_nothreat_rand_ant, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_ant$node), 
                       details=F))
rob_rand_3_ant<-robustness(ex3_rand_ant) # 0.8633781

#Scenario 4
endangdflemur_ant<-endangdflemur_ant[order(-endangdflemur_ant$status,endangdflemur_ant$area),]
endangdflemur_ant$node <-as.numeric(endangdflemur_ant$node)
lemur_names <- as.data.frame(rownames(bipart_0s_nothreat_rand_ant))
colnames(lemur_names) <- "name"
endangdflemur2_ant <- left_join(lemur_names, endangdflemur_ant)
rownames(endangdflemur2_ant) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_ant)[1]))
endangdflemur2_ant$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_ant)[1]))
(ex4_rand_ant <- second.extinct(bipart_0s_nothreat_rand_ant, participant="lower", method="external",
                       ext.row=as.numeric(endangdflemur2_ant$node), 
                       details=F))

rob_rand4_ant<-robustness(ex4_rand_ant)


  ###network level results
  netres_extinct_ant <-networklevel(bipart_0s_nothreat_rand_ant, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
   netres_random_ant[i,]<-cbind(as.data.frame(t(netres_extinct_ant)),rob_rand1_ant ,rob_rand2_ant, rob_rand_3_ant, rob_rand4_ant)
}

summary(netres_random_ant)




min(netres_random_ant$connectance)
max(netres_random_ant$connectance)
median(netres_random_ant$connectance)

min(netres_random_ant$nest)
max(netres_random_ant$nest)
median(netres_random_ant$nest)

min(netres_random_ant$robust1)
max(netres_random_ant$robust1)
median(netres_random_ant$robust1)

min(netres_random_ant$robust2)
max(netres_random_ant$robust2)
median(netres_random_ant$robust2)

min(netres_random_ant$robust3)
max(netres_random_ant$robust3)
median(netres_random_ant$robust3)

min(netres_random_ant$robust4)
max(netres_random_ant$robust4)
median(netres_random_ant$robust4)


#compute p-values

p.con_ant <- prop(~connectance >= netres_ant[1], data= netres_random_ant)
p.con2_ant <- prop(~connectance <= netres_ant[1], data= netres_random_ant)  
p.con_ex_ant <- prop(~connectance >= netres_extinct_ant[1], data= netres_random_ant)
p.con_ex2_ant <- prop(~connectance <= netres_extinct_ant[1], data= netres_random_ant)  

p.nest_ant<- prop(~nest >= netres_ant[3], data= netres_random_ant)
p.nest2_ant <- prop(~nest <= netres_ant[3], data= netres_random_ant)  
p.nest_ex_ant <- prop(~nest >= netres_extinct_ant[3], data= netres_random_ant)
p.nest_ex2_ant <- prop(~nest <= netres_extinct_ant[3], data= netres_random_ant) 

p.rob1_ant <- prop(~robust1 >= rob1_ant, data= netres_random_ant)
p.rob12_ant <- prop(~robust1 <= rob1_ant, data= netres_random_ant)  
p.rob1_ex_ant <- prop(~robust1 >= rob_ext_1_ant, data= netres_random_ant)
p.rob1_ex2_ant <- prop(~robust1  <= rob_ext_1_ant, data= netres_random_ant) 

p.rob2_ant <- prop(~robust2 >= rob2_ant, data= netres_random_ant)
p.rob22_ant <- prop(~robust2 <= rob2_ant, data= netres_random_ant)  
p.rob2_ex_ant <- prop(~robust2 >= rob_ext_2_ant, data= netres_random_ant)
p.rob2_ex2_ant <- prop(~robust2  <= rob_ext_2_ant, data= netres_random_ant) 

p.rob3_ant <- prop(~robust3 >= rob3_ant, data= netres_random_ant)
p.rob32_ant <- prop(~robust3 <= rob3_ant, data= netres_random_ant)  
p.rob3_ex_ant <- prop(~robust3 >= rob_ext_3_ant, data= netres_random_ant)
p.rob3_ex2_ant <- prop(~robust3  <= rob_ext_3_ant, data= netres_random_ant) 

p.rob4_ant <- prop(~robust4 >= rob4_ant, data= netres_random_ant)
p.rob42_ant <- prop(~robust4 <= rob4_ant, data= netres_random_ant)  
p.rob4_ex_ant <- prop(~robust4 >= rob_extinct_4_ant, data= netres_random_ant)
p.rob4_ex2_ant <- prop(~robust4  <= rob_extinct_4_ant, data= netres_random_ant) 


netres_random2 <- netres_random%>%
  pivot_longer(cols = c(5:8), values_to= "Robustness", names_to ="Scenario")%>%
   mutate(Scenario = factor(Scenario, levels=c("robust5", "robust2", "robust3", "robust4")))

ggplot(data= netres_random2, aes(y=Robustness, x= Scenario))+
  geom_boxplot()+
  theme_classic()+
  scale_x_discrete(labels=c("robust5" = "Random", "robust2" = "Degree High-Low",
                              "robust3" = "Degree Low-High", "robust4" = "Extinction Likelihood"))

summary(aov(netres_random2$Robustness~netres_random2$Scenario))
TukeyHSD(aov(netres_random2$Robustness~netres_random2$Scenario))

```

```{r Modularity Null Model Antagonistic Network - Lemur}
net2_antagontistic<-net_antagonistic

mod_random_ant<-data.frame(mod=NA)

for(i in 1:100){
  set.seed(i)
  n<-50
  rand<-rbinom(n,1,0.62)
  summary(as.factor(rand))
 
  rand<-c(rand,rep("NA",length(network.vertex.names(net_antagonistic)[50:length(network.vertex.names(net_antagonistic))])))
  
  net2_antagontistic%v%"rand"<-rand
  summary(net2_antagontistic%v%"rand")
  
   subgraph_nonthreatened_rand_ant<-get.inducedSubgraph(net2_antagontistic,which(net2_antagontistic%v%"rand"=="0"|net2_antagontistic%v%"type"=="tree"))
  
  subgraph_nonthreatened_rand_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_ant,cmode="indegree")
  subgraph_nonthreatened_rand2_ant<-get.inducedSubgraph(subgraph_nonthreatened_rand_ant,which(subgraph_nonthreatened_rand_ant%v%"degree">0))
  
  bipart_0s_nothreat_rand_ant<-as.matrix.network(subgraph_nonthreatened_rand2_ant)
  dim(bipart_0s_nothreat_rand_ant)

mod_ant_random <- computeModules(bipart_0s_nothreat_rand_ant)
mod_ant_random <- mod_ant_random@likelihood
  
 mod_random_ant[i,]<-cbind(mod_ant_random)
}

summary(mod_random_ant)
mod_random_ant
write.csv(mod_random_ant, "mod_random_ant.csv")



min(mod_random_ant)
max(mod_random_ant)
median(mod_random_ant$mod)

p.value_mod_ant <- prop(~mod >= mod_ant, data= mod_random_ant)
p.value_mod_an2t <- prop(~mod <= mod_ant, data= mod_random_ant)
p.value_mod_ant_ex <- prop(~mod >= mod_ant_extinct, data= mod_random_ant)
p.value_mod_ant_ex2 <- prop(~mod <= mod_ant_extinct, data= mod_random_ant)


```

#Antagonistic Tree Extinctions

```{r Original Antagonistic Network - Tree}

bipart3_antagonistic <- t(bipart_antagonistic)
bipart3_antagonistic[is.na(bipart3_antagonistic)] <- 0
dim(bipart3_antagonistic)

# Scienario 1: Random 
(ex_t_ant <- second.extinct(bipart3_antagonistic, participant="lower", method="random", nrep=451, 
                      details=F))

rob1_t_ant<-robustness(ex_t_ant)

exdf_t_ant<-as.data.frame(ex_t_ant[1:451,])

# Scenario 2: removal of trees from highest to lowest degree
(ex2_t_ant <- second.extinct(bipart3_antagonistic, participant="lower", method="degree", nrep=451, 
                       details=F))

ex2df_t_ant<-as.data.frame(ex2_t_ant[1:451,])

rob2_t_ant<-robustness(ex2_t_ant)


#Scenario 3: remove lemurs from lowest to highest degree
net_antagonistic %v% "degree" <- sna::degree(net_antagonistic,cmode="indegree")
degreedf2_t_ant<-as.data.frame(net_antagonistic%v%"degree")
degreedf2_t_ant$node<-rownames(degreedf2_t_ant)
degreedf2_t_ant$name<-net_antagonistic%v%"vertex.names"
degreedf2_t_ant$node <- as.numeric(degreedf2_t_ant$node)-50
degreedf2_t_ant$node <- sort(degreedf2_t_ant$node)

ant_trees <- as.data.frame(rownames(bipart3_antagonistic))
colnames(ant_trees) <- "name"
degreedf2_t_ant2 <- merge(degreedf2_t_ant,ant_trees, by="name" )
dim(degreedf2_t_ant2)
degreedf2_t_ant2<-sort(degreedf2_t_ant2)
as.numeric(degreedf2_t_ant2$node)
degreedf2_t_ant2$`net_antagonistic %v% "degree"` <- sort(as.numeric(degreedf2_t_ant2$`net_antagonistic %v% "degree"`))

dim(bipart3_antagonistic)
dim(degreedf2_t_ant2)

(ex3_t_ant <- second.extinct(bipart3_antagonistic, participant="lower", method="external",ext.row=as.numeric(degreedf2_t_ant2$node), 
                       details=F))

rob3_t_ant<-robustness(ex3_t_ant)
ex3df_t_ant<-as.data.frame(ex3_t_ant[1:451,])

#Scenario 4: Remove lemurs according to extinction likelihood 

###using removal of hosts from most to least endangered
vertextraits_antagonistic$mIUCN<- relevel(factor(vertextraits_antagonistic$mIUCN),ref = "1")
Threat_t_ant<-as.character(vertextraits_antagonistic$mIUCN)
summary(Threat_t_ant)
length(Threat_t_ant)
names(Threat_t_ant)<-vertextraits_antagonistic$species
length(Threat_t_ant)
Threat_t_ant<-Threat_t_ant[ net_antagonistic %v% 'vertex.names' ]
network::set.vertex.attribute(net_antagonistic,"Threat",Threat_t_ant)


dim(bipart3_antagonistic)
ant_trees <- as.data.frame(rownames(bipart3_antagonistic))
colnames(ant_trees) <- "species"

Threat_traits2_ant <- merge(endangdf_t_ant, ant_trees, by="species")
dim(Threat_traits2_ant)

Threat_traits2_ant$status <- as.numeric(Threat_traits2_ant$status)
dim(Threat_traits2_ant)
Threat_traits2_ant$node <- rep(1:451)

##order from first to last the species that are most endangered
Threat_traits2_ant<-Threat_traits2_ant[order(-Threat_traits2_ant$status),]
dim(Threat_traits2_ant)
dim(bipart3_antagonistic)

(ex4_t_ant <- second.extinct(bipart3_antagonistic, participant="lower", method="external", ext.row=as.numeric(Threat_traits2_ant$node), 
                       details=F))

rob4_t_ant<-robustness(ex4_t_ant)

ex4df_t_ant<-as.data.frame(ex4_t_ant[1:451,])

#combine the different extinction scenarios
exdfs_t_ant<-cbind(exdf_t_ant,ex2df_t_ant,ex3df_t_ant,ex4df_t_ant)
colnames(exdfs_t_ant)<-c("no","ex.low","ext.rand","no",
                   "ex.low","ext.deghigh","no","ex.low","ext.deglow",
                   "no","ex.low","ext.end")
summary(exdfs_t_ant)
##convert to %
exdfs_t_ant$perc.no<-exdfs_t_ant$no/451*100
exdfs_t_ant$perc.ext.rand<-100-(exdfs_t_ant$ext.rand/50*100)
exdfs_t_ant$perc.ext.deghigh<-100-(exdfs_t_ant$ext.deghigh/50*100)
exdfs_t_ant$perc.ext.deglow<-100-(exdfs_t_ant$ext.deglow/50*100)
exdfs_t_ant$perc.ext.end<-100-(exdfs_t_ant$ext.end/50*100)

exdfs_t_ant$ext.rand.cum <- cumsum(exdfs_t_ant$ext.rand)
exdfs_t_ant$ext.deghigh.cum <- cumsum(exdfs_t_ant$ext.deghigh)
exdfs_t_ant$ext.deglow.cum <- cumsum(exdfs_t_ant$ext.deglow)
exdfs_t_ant$ext.end.cum <- cumsum(exdfs_t_ant$ext.end)

exdfs_t_ant$perc.ext.rand.cum<-100-(exdfs_t_ant$ext.rand.cum/50*100)
exdfs_t_ant$perc.ext.deghigh.cum<-100-(exdfs_t_ant$ext.deghigh.cum/50*100)
exdfs_t_ant$perc.ext.deglow.cum<-100-((exdfs_t_ant$ext.deglow.cum/50)*100)
exdfs_t_ant$perc.ext.end.cum<-100-((exdfs_t_ant$ext.end.cum/50)*100)

exdfs2_t_ant <- exdfs_t_ant%>%
  select(perc.no, perc.ext.rand, perc.ext.deghigh, perc.ext.deglow, perc.ext.end)

exdfs2_t2_ant <- exdfs_t_ant%>%
  select(perc.no, perc.ext.rand.cum, perc.ext.deghigh.cum, perc.ext.deglow.cum, perc.ext.end.cum)

#plot all of the extinction scenarios 
curve_plot_t2_ant <- ggplot(data= exdfs2_t2_ant, aes(x= perc.no, y=perc.ext.rand.cum))+
  ylab("% Lemurs With Interaction(s)")+
  xlab("% Trees Extinct")+
  theme_classic()+
  geom_point(color="black", alpha=0.1)+
  geom_smooth(color="black")+
  geom_point(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9", alpha=0.1)+
  geom_point(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00", alpha=0.1)+  
  geom_smooth(aes(x= perc.no, y=perc.ext.end.cum), color="#D55E00")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deghigh.cum), color="#56B4E9")+
  geom_smooth(aes(x= perc.no, y=perc.ext.deglow.cum), color="#E69F00")+
  theme(axis.title=element_text(size=9))

lemur_curve_plots <- ggarrange(curve_plot2+ rremove("ylab") + rremove("xlab"),
                            curve_plot2_fruit+ rremove("ylab")+ rremove("xlab"),
                            curve_plot2_ant+ rremove("ylab")+ rremove("xlab"),
                            nrow=1)


plant_curve_plots <- ggarrange(curve_plot_t2+ rremove("ylab") + rremove("xlab"),
                            curve_plot_t2_fruit+ rremove("ylab") + rremove("xlab"),
                            curve_plot_t2_ant+ rremove("ylab") + rremove("xlab"),
                            nrow=1)


curve_plots_all <- ggarrange(curve_plot2, curve_plot2_fruit, curve_plot2_ant,curve_plot_t2,curve_plot_t2_fruit, curve_plot_t2_ant, labels = c("A", "B", "C", "D", "E", "F"), ncol=3, nrow=2, font.label = list(size=10))

```

```{r Post-Extinction Antagonistic Network - Tree}
iucn_ant<-iucn[ net_antagonistic %v% 'vertex.names' ]
network::set.vertex.attribute(net_antagonistic,"iucn",iucn_ant)
network::get.vertex.attribute(net_antagonistic,"iucn")

#Subgraph network so that it does not include EN or CR species
subgraph_reduced_iucn_ant<-get.inducedSubgraph(net_antagonistic,which(!is.na(net_antagonistic%v%"iucn")|net_antagonistic%v%"type"=="lemur"))
subgraph_nonthreatened_t_ant<-get.inducedSubgraph(subgraph_reduced_iucn_ant,which(subgraph_reduced_iucn_ant%v%"iucn"=="1"|subgraph_reduced_iucn_ant%v%"iucn"=="2"|subgraph_reduced_iucn_ant%v%"iucn"=="3"|subgraph_reduced_iucn_ant%v%"type"=="lemur"))
network.vertex.names(subgraph_nonthreatened_t_ant)
subgraph_nonthreatened_t_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_t_ant,cmode="indegree")
summary(subgraph_nonthreatened_t_ant%v%"degree")
subgraph_nonthreatened2_t_ant<-get.inducedSubgraph(subgraph_nonthreatened_t_ant,which(subgraph_nonthreatened_t_ant%v%"degree">0))


bipart_0s_nothreat_t_ant<-as.matrix.network(subgraph_nonthreatened2_t_ant)
bipart_0s_nothreat_t_ant <- t(bipart_0s_nothreat_t_ant)
dim(bipart_0s_nothreat_t_ant)



##secondary extinction

# Scenario 1 
(ex_extinct_t_ant <- second.extinct(bipart_0s_nothreat_t_ant, participant="lower", method="random", nrep=451, 
                              details=F))
rob_ext_1_t_ant<-robustness(ex_extinct_t_ant)


# Scenario 2
(ex2_extinct_t_ant <- second.extinct(bipart_0s_nothreat_t_ant, participant="lower", method="degree", nrep=451, details=F))

rob_ext_2_t_ant<-robustness(ex2_extinct_t_ant)


# Scenario3 

net_threat_t_ant<-network(bipart_0s_nothreat_t_ant,bipartite=T,matrix.type="bipartite")
dim(bipart_0s_nothreat_t_ant)
net_threat_t_ant %v% "degree" <- sna::degree(net_threat_t_ant,cmode="indegree")
degreedf2_t_ant<-as.data.frame(net_threat_t_ant%v%"degree")
degreedf2_t_ant$node<-rownames(degreedf2_t_ant)
degreedf2_t_ant$name<-net_threat_t_ant%v%"vertex.names"
degreedf2_t_ant$node <- as.numeric(degreedf2_t_ant$node)
degreedf2_t_ant$node <- sort(degreedf2_t_ant$node)
dim(bipart_0s_nothreat_t_ant)

ant_trees_nothreat <- as.data.frame(rownames(bipart_0s_nothreat_t_ant))
colnames(ant_trees_nothreat) <- "name"
degreedf2_t_ant2 <- merge(degreedf2_t_ant,ant_trees_nothreat, by="name" )
dim(degreedf2_t_ant2)
degreedf2_t_ant2<-sort(degreedf2_t_ant2)
as.numeric(degreedf2_t_ant2$node)
degreedf2_t_ant2$`net_threat_t_ant %v% "degree"` <- sort(as.numeric(degreedf2_t_ant2$`net_threat_t_ant %v% "degree"`))


(ex3_extinct_t_ant <- second.extinct(bipart_0s_nothreat_t_ant, participant="lower", method="external",ext.row=as.numeric(degreedf2_t_ant2$node), 
                       details=F))

rob_ext_3_t_ant<-robustness(ex3_extinct_t_ant)


#Scenario 4 
##order from first to last the species that are most endangered
dim(bipart_0s_nothreat_t_ant)
dim(ant_trees_nothreat)
dim(endangdf_t_ant)
ant_trees_nothreat$species <- ant_trees_nothreat$name
endangdftree2_ant <- merge(endangdf_t_ant, ant_trees_nothreat, by="species" )
endangdftree2_ant$status <- as.numeric(endangdftree2_ant$status)
endangdftree2_ant<-endangdftree2_ant[order(-endangdftree2_ant$status),]
dim(endangdftree2_ant)
rownames(endangdftree2_ant) <- rep(1:243)
endangdftree2_ant$node <- rep(1:243)

(ex4_extinct_t_ant <- second.extinct(bipart_0s_nothreat_t_ant, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2_ant$node), 
                       details=F))

rob_extinct_4_t_ant<-robustness(ex4_extinct_t_ant)



########connectance and other measures on the bipartite network
netres_extinct_t_ant<-networklevel(bipart_0s_nothreat_t_ant, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                             ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                             nrep = 20, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                             logbase="e", intereven="prod", H2_integer=TRUE, fcweighted=TRUE, 
                             fcdist="euclidean", legacy=FALSE)

netres_extinct_t_ant

as.data.frame(netres_extinct_t_ant)

g_ant_extinct_t <- igraph::graph.incidence(bipart_0s_nothreat_t_ant)
wtc_ant_extinct_t <- cluster_walktrap(g_ant_extinct_t)
mod_extinct_t <- modularity(wtc_ant_extinct_t)

mod_ant_extinct_trees <- computeModules(bipart_0s_nothreat_t_ant)
mod_ant_extinct_trees <- mod_ant_extinct_trees@likelihood

```

```{r Null model Antagonistic Network - Tree}

net2_antagontistic<-net_antagonistic

netres_random_phy_t_ant<-data.frame(connectance=NA,
                              comps=NA,
                              nest=NA,
                              robust1=NA,
                              robust2=NA,
                              robust3=NA, 
                              robust4=NA)

for(i in 1:100){
  set.seed(i)
   n <- 451
  rand_t<-rbinom(n,1,0.06651885)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",50), rand_t)
  
  net2_antagontistic%v%"rand_t"<-rand_t
  summary(net2_antagontistic%v%"rand_t")
  
   subgraph_nonthreatened_rand_t_ant<-get.inducedSubgraph(net2_antagontistic,which(net2_antagontistic%v%"rand_t"=="0"|net2_antagontistic%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t_ant,cmode="indegree")
  subgraph_nonthreatened_rand2_t_ant<-get.inducedSubgraph(subgraph_nonthreatened_rand_t_ant,which(subgraph_nonthreatened_rand_t_ant%v%"degree">0))
  
  bipart_0s_nothreat_rand_t_ant<-as.matrix.network(subgraph_nonthreatened_rand2_t_ant)
  dim(bipart_0s_nothreat_rand_t_ant)
  
  bipart_0s_nothreat_rand_t2_ant <- t(bipart_0s_nothreat_rand_t_ant)
bipart_0s_nothreat_rand_t2_ant[is.na(bipart_0s_nothreat_rand_t2_ant)] <- 0
dim(bipart_0s_nothreat_rand_t2_ant)

  
  
  (ex_rand_t_ant <- second.extinct(bipart_0s_nothreat_rand_t2_ant, participant="lower", method="random", nrep=as.numeric(nrow(bipart_0s_nothreat_rand_t2_ant)), 
                             details=F))

  rob_rand1_t_ant<-robustness(ex_rand_t_ant) 
  
  (ex2_rand_t_ant<- second.extinct(bipart_0s_nothreat_rand_t2_ant, participant="lower", method="degree", nrep=dim(bipart_0s_nothreat_t_ant)[1], 
                              details=F))

  rob_rand2_t_ant<-robustness(ex2_rand_t_ant) 
 
#Scenario 3 

degreedf3_t_ant<-as.data.frame(subgraph_nonthreatened_rand2_t_ant%v%"degree")
degreedf3_t_ant$node<-rownames(degreedf3_t_ant)
degreedf3_t_ant$name<-subgraph_nonthreatened_rand2_t_ant%v%"vertex.names"
degreedfhost3_t_ant<-degreedf3_t_ant[-c(1:as.numeric(ncol(bipart_0s_nothreat_rand_t2_ant))),]
degreedfhost3_t_ant<-sort(degreedfhost3_t_ant)
degreedfhost3_t_ant$node2 <- as.numeric(degreedfhost3_t_ant$node)-as.numeric(ncol(bipart_0s_nothreat_rand_t2_ant))



(ex3_extinct_rand_t_ant <- second.extinct(bipart_0s_nothreat_rand_t2_ant, participant="lower", method="external",
                       ext.row=as.numeric(degreedfhost3_t_ant$node2), 
                       details=F))

rob_rand3_t_ant<-robustness(ex3_extinct_rand_t_ant) #0.9732548 

#Scenario 4 
##order from first to last the species that are most endangered
endangdf_t_ant<-endangdf_t_ant[order(-as.numeric(endangdf_t_ant$status)),]
tree_names_ant<- as.data.frame(rownames(bipart_0s_nothreat_rand_t2_ant))
colnames(tree_names_ant) <- "name"
 endangdf_t_ant$name <-  endangdf_t_ant$species
endangdftree2_ant <- left_join(tree_names_ant, endangdf_t_ant)
rownames(endangdftree2_ant) <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2_ant)[1]))
endangdftree2_ant$node <- rep(1:as.numeric(nrow(bipart_0s_nothreat_rand_t2_ant)[1]))

(ex4_rand_t_ant <- second.extinct(bipart_0s_nothreat_rand_t2_ant, participant="lower", method="external",
                       ext.row=as.numeric(endangdftree2_ant$node), 
                       details=F))
rob_rand4_t_ant<-robustness(ex4_rand_t_ant)


  
  ###network level results
  netres_extinct_rand_t_ant <-networklevel(bipart_0s_nothreat_rand_t2_ant, index=c("connectance","number of compartments","nestedness"), level="lower", weighted=F, 
                                    ISAmethod="Bluethgen",  SAmethod = "Bluethgen", extinctmethod = "r", 
                                    nrep = 2, CCfun=median, dist="horn", normalise=TRUE, empty.web=TRUE, 
                                    logbase="e", intereven="prod", fcweighted=TRUE, 
                                    fcdist="euclidean", legacy=FALSE)
  
  
  netres_random_phy_t_ant[i,]<-cbind(as.data.frame(t(netres_extinct_rand_t_ant)),rob_rand1_t_ant, rob_rand2_t_ant, rob_rand3_t_ant, rob_rand4_t_ant)
}

summary(netres_random_phy_t_ant)

p.value <- prop(~connectance >= netres_ant[1], data= netres_random_phy_t_ant)
p.value <- prop(~connectance <= netres_ant[1], data= netres_random_phy_t_ant)  
p.value <- prop(~connectance >= netres_extinct_t_ant[1], data= netres_random_phy_t_ant)
p.value <- prop(~connectance <= netres_extinct_t_ant[1], data= netres_random_phy_t_ant)  

p.value <- prop(~comps >= netres_ant[2], data= netres_random_phy_t_ant)
p.value <- prop(~comps <= netres_ant[2], data= netres_random_phy_t_ant)  
p.value <- prop(~comps >= netres_extinct_t_ant[2], data= netres_random_phy_t_ant)
p.value <- prop(~comps <= netres_extinct_t_ant[2], data= netres_random_phy_t_ant)  

p.value <- prop(~nest >= netres_ant[3], data= netres_random_phy_t_ant)
p.value <- prop(~nest  <= netres_ant[3], data= netres_random_phy_t_ant)  
p.value <- prop(~nest  >= netres_extinct_t_ant[3], data= netres_random_phy_t_ant)
p.value <- prop(~nest  <= netres_extinct_t_ant[3], data= netres_random_phy_t_ant) 

p.value <- prop(~robust1 >= rob1_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust1  <= rob1_t_ant, data= netres_random_phy_t_ant)  
p.value <- prop(~robust1  >= rob_ext_1_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust1  <= rob_ext_1_t_ant, data= netres_random_phy_t_ant) 

p.value <- prop(~robust2 >= rob2_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust2  <= rob2_t_ant, data= netres_random_phy_t_ant)  
p.value <- prop(~robust2  >= rob_ext_2_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust2  <= rob_ext_2_t_ant, data= netres_random_phy_t_ant) 

p.value <- prop(~robust3 >= rob3_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust3  <= rob3_t_ant, data= netres_random_phy_t_ant)  
p.value <- prop(~robust3  >= rob_ext_3_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust3  <= rob_ext_3_t_ant, data= netres_random_phy_t_ant) 

p.value <- prop(~robust4 >= rob4_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust4  <= rob4_t_ant, data= netres_random_phy_t_ant)  
p.value <- prop(~robust4  >= rob_extinct_4_t_ant, data= netres_random_phy_t_ant)
p.value <- prop(~robust4  <= rob_extinct_4_t_ant, data= netres_random_phy_t_ant) 

```

```{r Modularity Null Model Antagonistic Network - Tree}
net2_antagontistic<-net_antagonistic

mod_random_phy_t_ant<-data.frame(mod=NA)

for(i in 1:100){
  set.seed(i)
   n <- 451
  rand_t<-rbinom(n,1,0.06651885)### the proportion of trees that are EN or CR 
  summary(as.factor(rand_t))
 
  rand_t<-c(rep("NA",50), rand_t)
  
  net2_antagontistic%v%"rand_t"<-rand_t
  
  summary(net2_antagontistic%v%"rand_t")
  
   subgraph_nonthreatened_rand_t_ant<-get.inducedSubgraph(net2_antagontistic,which(net2_antagontistic%v%"rand_t"=="0"|net2_antagontistic%v%"type"=="lemur"))
  
  subgraph_nonthreatened_rand_t_ant%v%"degree"<-sna::degree(subgraph_nonthreatened_rand_t_ant,cmode="indegree")
  subgraph_nonthreatened_rand2_t_ant<-get.inducedSubgraph(subgraph_nonthreatened_rand_t_ant,which(subgraph_nonthreatened_rand_t_ant%v%"degree">0))
  
  bipart_0s_nothreat_rand_t_ant<-as.matrix.network(subgraph_nonthreatened_rand2_t_ant)
  dim(bipart_0s_nothreat_rand_t_ant)
  
  bipart_0s_nothreat_rand_t2_ant <- t(bipart_0s_nothreat_rand_t_ant)
bipart_0s_nothreat_rand_t2_ant[is.na(bipart_0s_nothreat_rand_t2_ant)] <- 0
dim(bipart_0s_nothreat_rand_t2_ant)

mod_ant_random_t <- computeModules(bipart_0s_nothreat_rand_t2_ant)
mod_ant_random_t <- mod_ant_random_t@likelihood
  
mod_random_phy_t_ant[i,]<-cbind(mod_ant_random_t)
}
mod_random_phy_t_ant
write.csv(mod_random_phy_t_ant, "mod_random_phy_t_ant.csv")
summary(mod_random_phy_t_ant)


min(mod_random_phy_t_ant)
max(mod_random_phy_t_ant)
median(mod_random_phy_t_ant$mod)

p.value_mod_ant_t <- prop(~mod >= mod_ant, data= mod_random_phy_t_ant)
p.value_mod_an2t_t<- prop(~mod <= mod_ant, data= mod_random_phy_t_ant)
p.value_mod_ant_ex_t <- prop(~mod >= mod_ant_extinct_t, data= mod_random_phy_t_ant)
p.value_mod_ant_ex2_t <- prop(~mod <= mod_ant_extinct_t, data= mod_random_phy_t_ant)



```

#Visualization

```{r Make figures}
mod_random_phy_t <- read.csv("mod_random_phy_t.csv")
mod_random_phy_t_ant <- read.csv("mod_random_phy_t_ant.csv")
mod_random_phy_t_fruit <- read.csv("mod_random_phy_t_fruit.csv")


library(ggridges)
netres_random_total2 <- netres_random_total %>%
  select(robust1:type)%>%
  pivot_longer(names_to = "Scenario", values_to = "Robustness", cols= robust1:robust4)


netres_random_total_trees2 <- netres_random_total_trees %>%
  select(robust1:type)%>%
  pivot_longer(names_to = "Scenario", values_to = "Robustness", cols= robust1:robust4)
netres_random_total_trees2$Mode <- "Plants"
dim(netres_random_total_trees2)
netres_random_total2$Mode <- "Lemurs"
dim(netres_random_total2)
netres_random_total_both <- rbind(netres_random_total_trees2, netres_random_total2)
netres_random_total_both$Scenario2 <- paste(netres_random_total_both$Scenario, netres_random_total_both$Mode, sep="_")

robust_df_both$Scenario2 <- paste(robust_df_both$Scenario, robust_df_both$Mode, sep="_")
robust_df_both$Type2[robust_df_both$Type2=="Random"] <- "Pre-Extinction"
robust_df_both$Type2[robust_df_both$Type2=="Original"] <- "Pre-Extinction"

netres_random2 <- netres_random
netres_random2$mode <- "Lemurs"
netres_random_fruit2 <- netres_random_fruit
netres_random_fruit2$mode <- "Lemurs"
netres_random_fruit2$type <- "Mutualistic"
netres_random_ant2 <- netres_random_ant
netres_random_ant2$mode <- "Lemurs"
netres_random_ant2$type <- "Antagonistic"
netres_random_ant2$mod <- mod_random_ant$mod

netres_random_phy_t1
netres_random_phy_t2b <- netres_random_phy_t2[53:69,]
netres_random_phy_t3b <- netres_random_phy_t3[71:102,]

netres_random_t2 <- rbind(netres_random_phy_t1,netres_random_phy_t2b,netres_random_phy_t3b )
netres_random_t2$mode <- "Plants"
netres_random_t2$type<- "Hybrid"
netres_random_t2$mod <- mod_random_phy_t$mod
netres_random_t_fruit2 <- netres_random_phy_t_fruit
netres_random_t_fruit2$mod <- mod_random_phy_t_fruit$mod
netres_random_t_fruit2$mode <- "Plants"
netres_random_t_fruit2$type <- "Mutualistic"
netres_random_t_ant2 <- netres_random_phy_t_ant
netres_random_t_ant2$mod <- mod_random_phy_t_ant$mod
netres_random_t_ant2$mode <- "Plants"
netres_random_t_ant2$type <- "Antagonistic"

colnames(netres_random2)
colnames(netres_random_fruit2)
colnames(netres_random_ant2)
colnames(netres_random_t2)
colnames(netres_random_t_fruit2)
colnames(netres_random_t_ant2)

structure_data_random <- rbind(netres_random2, netres_random_fruit2,netres_random_ant2, netres_random_t2, netres_random_t_fruit2, netres_random_t_ant2)

robust_data_random <- structure_data_random[,4:10]
robust_data_random2 <-robust_data_random %>%
  pivot_longer(cols = 1:4, names_to="scenario")
robust_data_random2$scenario2 <- paste(robust_data_random2$scenario, robust_data_random2$mode)

robust_data_random2$scenario2 <- factor(robust_data_random2$scenario2, levels =c("robust4 Plants", "robust3 Plants", "robust2 Plants", "robust1 Plants", "robust4 Lemurs", "robust3 Lemurs", "robust2 Lemurs", "robust1 Lemurs") )
 
robust1_df<- as.data.frame(c(rob1, rob_ext_1, rob1_ant, rob_ext_1_ant, rob1_fruit, rob_ext_1_fruit))
colnames(robust1_df) <- "Robustness"
robust1_df$Scenario <- "robust1"
robust1_df$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust1_df$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust1_df$Mode <- "Lemurs"

robust1_df_t<- as.data.frame(c(rob1_t, rob_ext_1_t, rob1_t_ant, rob_ext_1_t_ant, rob1_t_fruit, rob_ext_1_t_fruit))
colnames(robust1_df_t) <- "Robustness"
robust1_df_t$Scenario <- "robust1"
robust1_df_t$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust1_df_t$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust1_df_t$Mode <- "Plants"

robust2_df<- as.data.frame(c(rob2, rob_ext_2, rob2_ant, rob_ext_2_ant, rob2_fruit, rob_ext_2_fruit))
colnames(robust2_df) <- "Robustness"
robust2_df$Scenario <- "robust2"
robust2_df$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust2_df$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust2_df$Mode <- "Lemurs"

robust2_df_t<- as.data.frame(c(rob2_t, rob_ext_2_t, rob2_t_ant, rob_ext_2_t_ant, rob2_t_fruit, rob_ext_2_t_fruit))
colnames(robust2_df_t) <- "Robustness"
robust2_df_t$Scenario <- "robust2"
robust2_df_t$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust2_df_t$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust2_df_t$Mode <- "Plants"

robust3_df<- as.data.frame(c(rob3, rob_ext_3, rob3_ant, rob_ext_3_ant, rob3_fruit, rob_ext_3_fruit))
colnames(robust3_df) <- "Robustness"
robust3_df$Scenario <- "robust3"
robust3_df$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust3_df$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust3_df$Mode <- "Lemurs"

robust3_df_t<- as.data.frame(c(rob3_t, rob_ext_3_t, rob3_t_ant, rob_ext_3_t_ant, rob3_t_fruit, rob_ext_3_t_fruit))
colnames(robust3_df_t) <- "Robustness"
robust3_df_t$Scenario <- "robust3"
robust3_df_t$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust3_df_t$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust3_df_t$Mode <- "Plants"

robust4_df<- as.data.frame(c(rob4, rob_extinct_4, rob4_ant, rob_extinct_4_ant, rob4_fruit, rob_extinct_4_fruit))
colnames(robust4_df) <- "Robustness"
robust4_df$Scenario <- "robust4"
robust4_df$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust4_df$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust4_df$Mode <- "Lemurs"

robust4_df_t<- as.data.frame(c(rob4_t, rob_extinct_4_t, rob4_t_ant, rob_extinct_4_t_ant, rob4_t_fruit, rob_extinct_4_t_fruit))
colnames(robust4_df_t) <- "Robustness"
robust4_df_t$Scenario <- "robust4"
robust4_df_t$Type <- c("Hybrid", "Hybrid","Antagonistic", "Antagonistic","Mutualistic", "Mutualistic")
robust4_df_t$Type2 <- c("Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
robust4_df_t$Mode <- "Plants"

robust_points_data <- rbind(robust1_df, robust1_df_t,robust2_df, robust2_df_t,robust3_df, robust3_df_t,robust4_df, robust4_df_t)
robust_points_data$Scenario2 <- paste(robust_points_data$Scenario, robust_points_data$Mode)

#ROBUSTNESS FIGURE RIDGE PLOT
ridge_plot3 <- ggplot(robust_data_random2, aes(x=value, y=scenario2, fill = type))+
  geom_density_ridges(alpha=0.7, color=NA)+
  theme_classic()+
   scale_fill_colorblind("Network Type")+
  scale_y_discrete(labels=c("robust1 Plants" = "Random Plants", "robust2 Plants" = "Degree High-Low Plants", "robust3 Plants" = "Degree Low-High Plants", "robust4 Plants"= "Extinction Likelihood Plants","robust1 Lemurs" = "Random Lemurs", "robust2 Lemurs" = "Degree High-Low Lemurs", "robust3 Lemurs" = "Degree Low-High Lemurs", "robust4 Lemurs"= "Extinction Likelihood Lemurs"))+
  ylab("Extinction Scenario")+
  xlab("Robustness")+
  geom_jitter(data=robust_points_data, aes(x=Robustness, y=Scenario2, fill=Type, shape=Type2), size=2, width=0, height=0.2)+
   scale_color_colorblind()+
 scale_shape_manual(values = c(21, 24))+
  theme(legend.title=element_blank())

#ROBUSTNESS FIGURE SCATTERPLOT

curve_plots_all <- ggarrange(curve_plot2, curve_plot2_fruit, curve_plot2_ant,curve_plot_t2,curve_plot_t2_fruit, curve_plot_t2_ant, labels = c("A", "B", "C", "D", "E", "F"), ncol=3, nrow=2, font.label = list(size=10))

#STRUCTURE PLOTS

structure_points_df <- rbind(netres, netres_extinct, netres_fruit, netres_extinct_fruit, netres_ant, netres_extinct_ant, netres, netres_extinct_rand_t, netres_fruit, netres_extinct_t_fruit, netres_ant, netres_extinct_t_ant)
structure_points_df <- as.data.frame(structure_points_df)
structure_points_df$Network_Type <- c("Hybrid", "Hybrid", "Mutualistic", "Mutualistic", "Antagonistic", "Antagonistic","Hybrid", "Hybrid", "Mutualistic", "Mutualistic", "Antagonistic", "Antagonistic")
structure_points_df$Mode <- c("Lemurs", "Lemurs", "Lemurs", "Lemurs","Lemurs", "Lemurs","Plants", "Plants","Plants", "Plants","Plants", "Plants")
structure_points_df$Type <- c("Pre-Extinction", "Post-Extinction", "Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction","Pre-Extinction", "Post-Extinction")
structure_points_df$mod <- c(mod_hybrid, mod_extinct, mod_mut, mod_mut_extinct, mod_ant, mod_ant_extinct, mod_hybrid, mod_extinct_t, mod_mut, mod_mut_extinct_t, mod_ant, mod_ant_extinct_trees)

ridge_plot_connectance <- ggplot(structure_data_random , aes(x=connectance, y=mode, fill = type))+
  geom_density_ridges(alpha=0.7, color=NA)+
  theme_classic()+
  scale_fill_colorblind("Network Type")+
  xlab("Connectance")+
  geom_jitter(data=structure_points_df, aes(x=connectance, y=Mode, fill=Network_Type, shape=Type), size=2, alpha=0.9, width=0, height=0.2)+
   scale_color_colorblind()+
 scale_shape_manual(values = c(21, 24))+
  theme(legend.title=element_blank()) +
  ylab("Mode")


ridge_plot_nestedness <- ggplot(structure_data_random , aes(x=nest, y=mode, fill = type))+
  geom_density_ridges(alpha=0.7, color=NA)+
  theme_classic()+
  scale_fill_colorblind("Network Type")+
  xlab("Nestedness Temperature")+
  geom_jitter(data=structure_points_df, aes(x=nestedness, y=Mode, fill=Network_Type, shape=Type), size=2, alpha=0.9, width=0, height=0.2)+
   scale_color_colorblind()+
 scale_shape_manual(values = c(21, 24))+
  theme(legend.title=element_blank()) +
  ylab("Mode")

ridge_plot_modularity <- ggplot(structure_data_random , aes(x=mod, y=mode, fill = type))+
  geom_density_ridges(alpha=0.7, color=NA)+
  theme_classic()+
  scale_fill_colorblind("Network Type")+
  xlab("Modularity")+
  geom_jitter(data=structure_points_df, aes(x=mod, y=Mode, fill=Network_Type, shape=Type), size=2, alpha=0.9, width=0, height=0.2)+
   scale_color_colorblind()+
 scale_shape_manual(values = c(21, 24))+
  theme(legend.title=element_blank()) +
  ylab("Mode")

structure_plots <-ggarrange(ridge_plot_connectance, ridge_plot_nestedness, ridge_plot_modularity, labels = c("A", "B", "C"), common.legend = TRUE)
```
 

